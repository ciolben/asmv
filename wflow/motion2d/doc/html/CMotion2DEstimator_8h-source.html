<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<title>Motion2D: a software to estimate 2D parametric motion models</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta content="Motion2D: dominant motion estimation" name=description>
<meta content="Motion2D,motion estimation,motion models,image processing" 
name=KeyWords>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>

<center>
<a href="http://www.irisa.fr/vista/Vista.english.html"><img src="logo-vista3.gif" alt="Vista" align=middle border=0></a> &nbsp;&nbsp;&nbsp;

<a href="index.html">Main Page</a> &nbsp;

<a href="annotated.html">Class List</a> &nbsp;

<a href="functions.html">Function List</a> &nbsp;

<a href="files.html">File List</a> &nbsp;

<a href="examples.html">Examples</a> &nbsp;
</center>

<hr>
<br>
<!-- Generated by Doxygen 1.2.18 -->
<h1>CMotion2DEstimator.h</h1><a href="CMotion2DEstimator_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"></span>
00003 <span class="comment">  Copyright (c) 1995-2005 by INRIA.</span>
00004 <span class="comment">  All Rights Reserved.</span>
00005 <span class="comment"></span>
00006 <span class="comment">  This software was developed at:</span>
00007 <span class="comment">  IRISA/INRIA Rennes</span>
00008 <span class="comment">  Campus Universitaire de Beaulieu</span>
00009 <span class="comment">  35042 Rennes Cedex</span>
00010 <span class="comment"></span>
00011 <span class="comment">  http://www.irisa.fr</span>
00012 <span class="comment"></span>
00013 <span class="comment">*/</span>
00014 
00020 <span class="preprocessor">#ifndef CMotion2DEstimator_h</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define CMotion2DEstimator_h</span>
00022 <span class="preprocessor"></span>
00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00024 
00025 <span class="preprocessor">#include &lt;<a class="code" href="CMotion2DPyramid_8h.html">CMotion2DPyramid.h</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;<a class="code" href="CMotion2DModel_8h.html">CMotion2DModel.h</a>&gt;</span>
00027 
00028 
00029 <span class="preprocessor">#if defined (WIN32)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#  if defined MOTION2D_DLL_EXPORTS</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#     define MOTION2D_API __declspec( dllexport )</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#  elif defined MOTION2D_DLL_IMPORTS</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#     define MOTION2D_API __declspec( dllimport )</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#  else</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#     define MOTION2D_API</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#  endif</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#     define MOTION2D_API</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span>
00041 
00042 
<a name="l00043"></a><a class="code" href="classCMotion2DEstimator.html">00043</a> <span class="keyword">class </span>MOTION2D_API <a class="code" href="classCMotion2DEstimator.html">CMotion2DEstimator</a>
00044 {
00045  <span class="keyword">public</span>:
00046 
<a name="l00055"></a><a class="code" href="classCMotion2DEstimator.html#s7">00055</a>   <span class="keyword">enum</span> ERobustFunction {
00056     Tukey,
00059     Talwar,
00062     Cauchy,
00064     Welsh
00066   };
00067 
00083   <span class="keyword">enum</span> ECConstType {
00084     CConst_Fixed,
00087     CConst_Classic,
00090     CConst_Robust
00092   };
00093 
00094  <span class="keyword">public</span>:
00095   <a class="code" href="classCMotion2DEstimator.html">CMotion2DEstimator</a>();
00096   ~<a class="code" href="classCMotion2DEstimator.html">CMotion2DEstimator</a>();
00097 
00098   <span class="keywordtype">bool</span> estimate(<span class="keyword">const</span> <a class="code" href="classCMotion2DPyramid.html">CMotion2DPyramid</a> &amp; pyramid1,
00099                 <span class="keyword">const</span> <a class="code" href="classCMotion2DPyramid.html">CMotion2DPyramid</a> &amp; pyramid2,
00100                 <span class="keyword">const</span> <span class="keywordtype">short</span> *support, <span class="keywordtype">short</span> label,
00101                 <a class="code" href="classCMotion2DModel.html">CMotion2DModel</a> &amp;model, <span class="keywordtype">bool</span> useModelAsInitialization=<span class="keyword">false</span>);
00102   <span class="keywordtype">bool</span> estimate(<span class="keyword">const</span> <a class="code" href="classCMotion2DPyramid.html">CMotion2DPyramid</a> &amp; pyramid1,
00103                 <span class="keyword">const</span> <a class="code" href="classCMotion2DPyramid.html">CMotion2DPyramid</a> &amp; pyramid2,
00104                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *support, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> label,
00105                 <a class="code" href="classCMotion2DModel.html">CMotion2DModel</a> &amp;model, <span class="keywordtype">bool</span> useModelAsInitialization=<span class="keyword">false</span>);
00106   <span class="keywordtype">float</span> *getWeights(<span class="keywordtype">int</span> &amp;n_rows, <span class="keywordtype">int</span> &amp;n_cols);
00107 
00108 
00117   <span class="keywordtype">void</span> setRobustEstimator(<span class="keywordtype">bool</span> robust=<span class="keyword">true</span>) {
00118     <span class="keywordflow">if</span> (robust == <span class="keyword">true</span>)
00119       least_mean_square = <span class="keyword">false</span>; <span class="comment">// iterated weighted least-square</span>
00120     <span class="keywordflow">else</span> {
00121       least_mean_square = <span class="keyword">true</span>; <span class="comment">// just least-square.</span>
00122       <span class="comment">//setNIterationMaxIRLS(1);</span>
00123     }
00124   };
00125 
00135   <span class="keywordtype">void</span> setRobustFunction(ERobustFunction function=Tukey) {
00136     <span class="keywordflow">switch</span> (function) {
00137     <span class="keywordflow">case</span> Tukey : ty_pond = 0; <span class="keywordflow">break</span>;
00138     <span class="keywordflow">case</span> Talwar: ty_pond = 1; <span class="keywordflow">break</span>;
00139     <span class="keywordflow">case</span> Cauchy: ty_pond = 2; <span class="keywordflow">break</span>;
00140     <span class="keywordflow">case</span> Welsh : ty_pond = 3; <span class="keywordflow">break</span>;
00141     }
00142   };
00151   <span class="keywordtype">void</span> setCConstant(ECConstType C_type=CConst_Fixed, <span class="keywordtype">double</span> C=8.0) {
00152     <span class="keywordflow">switch</span> (C_type) {
00153     <span class="keywordflow">case</span> CConst_Fixed:
00154       type_variance = 0; <span class="comment">// Fixed C constant.</span>
00155       variance =  C; <span class="comment">// Final value of the C constant</span>
00156       <span class="keywordflow">break</span>;
00157     <span class="keywordflow">case</span> CConst_Classic:
00158       type_variance = 1;
00159       <span class="keywordflow">break</span>;
00160     <span class="keywordflow">case</span> CConst_Robust:
00161       type_variance = 2;
00162       <span class="keywordflow">break</span>;
00163     }
00164   };
00165 
00179   <span class="keywordtype">void</span> setNIterationMaxIRLS(<span class="keywordtype">int</span> niter=8) {
00180     max_it_irls = niter;
00181   };
00182 
00191   <span class="keywordtype">void</span> setNIterationMaxLevel(<span class="keywordtype">int</span> niter=7) {
00192     max_it_stab = niter;
00193   };
00194 
00204   <span class="keywordtype">void</span> setLevelParameterIntroduction(<span class="keywordtype">int</span> level_const=-1,
00205                                      <span class="keywordtype">int</span> level_affine=-1,
00206                                      <span class="keywordtype">int</span> level_quadratic=-1) {
00207 
00208     level_ct   = level_const;
00209     level_lin  = level_affine;
00210     level_quad = level_quadratic;
00211   };
00212 
00236   <span class="keywordtype">bool</span> setFirstEstimationLevel(<span class="keywordtype">unsigned</span> level=3) {
00237     <span class="keywordflow">if</span> (level &gt;= (unsigned) <a class="code" href="classCMotion2DPyramid.html#s1s0">CMotion2DPyramid::NLEVELS_MAX</a>) {
00238        __panic(<span class="stringliteral">"Cmotion2DEstimator::setFirstEstimationLevel() : Bad level..."</span>);
00239        <span class="keywordflow">return</span> <span class="keyword">false</span>;
00240     }
00241     first_est_level = level;
00242     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00243   };
00244 
00256   <span class="keywordtype">unsigned</span> getFirstEstimationLevel() {
00257     <span class="keywordflow">return</span> pyr_level_max;
00258   };
00259 
00271   <span class="keywordtype">bool</span> setLastEstimationLevel(<span class="keywordtype">unsigned</span> level=0) {
00272     <span class="keywordflow">if</span> (level &gt;= (unsigned) <a class="code" href="classCMotion2DPyramid.html#s1s0">CMotion2DPyramid::NLEVELS_MAX</a>) {
00273        __panic(<span class="stringliteral">"Cmotion2DEstimator::setFirstEstimationLevel() : Bad level..."</span>);
00274        <span class="keywordflow">return</span> <span class="keyword">false</span>;
00275     }
00276 
00277     final_est_level = level;
00278     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00279   };
00280 
00290   <span class="keywordtype">unsigned</span> getLastEstimationLevel() {
00291     <span class="keywordflow">return</span> final_est_level;
00292   };
00293 
00300   <span class="keywordtype">void</span> setReliableSupportRate(<span class="keywordtype">float</span> rate=0.4) {
00301       <span class="keywordflow">if</span> ((rate &lt; 0.f) || (rate &gt; 1.f)) {
00302         __panic(<span class="stringliteral">"CMotion2DEstimator::setReliableSupportRate(): Bad rate..."</span>);
00303       }
00304       tx_pts_min = rate;
00305   };
00306 
00321   <span class="keywordtype">void</span> computeSupportSize(<span class="keywordtype">bool</span> compute=<span class="keyword">true</span>, <span class="keywordtype">float</span> threshold = 0.2f) {
00322     <span class="keywordflow">if</span> (compute == <span class="keyword">true</span>) {
00323       compute_support_size = 1; <span class="comment">// Calcul nb pixels conformes par rapport au</span>
00324                                 <span class="comment">// nb pixels zone de recouvrement.</span>
00325       <span class="keywordflow">if</span> ((threshold &lt; 0.f) || (threshold &gt; 1.f)) {
00326         __panic(<span class="stringliteral">"CMotion2DEstimator::computeSupportSize(): Bad threshold."</span>);
00327       }
00328       seuil_poids = threshold;  <span class="comment">// Seuil au dela duquel 1 pixel est</span>
00329       <span class="comment">// conforme au mvt.</span>
00330     }
00331     <span class="keywordflow">else</span>
00332       compute_support_size = 0;
00333   };
00334 
00342   <span class="keywordtype">bool</span> isSupportSizeComputed() {
00343     <span class="keywordflow">if</span> (compute_support_size == 1)
00344       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00345     <span class="keywordflow">else</span>
00346       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00347   };
00348 
00357   <span class="keywordtype">bool</span> getSupportSize(<span class="keywordtype">double</span> &amp;size) {
00358     <span class="keywordflow">if</span> (compute_support_size == 1) {
00359       size = rapport_poids;
00360       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00361     }
00362     <span class="keywordflow">else</span> {
00363       <span class="comment">// The support size is not computed</span>
00364       size = 0.0;
00365       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00366     }
00367   };
00368 
00377   <span class="keywordtype">void</span> computeResidualVariance(<span class="keywordtype">bool</span> compute=<span class="keyword">false</span>) {
00378     compute_sigma2res = compute;
00379   };
00380 
00390   <span class="keywordtype">bool</span> isResidualVarianceComputed() {
00391     <span class="keywordflow">if</span> (compute_sigma2res == <span class="keyword">true</span>)
00392       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00393     <span class="keywordflow">else</span>
00394       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00395   };
00396 
00404   <span class="keywordtype">double</span> getResidualVariance() {<span class="keywordflow">return</span> sigma2res; };
00405 
00414   <span class="keywordtype">void</span> computeCovarianceMatrix(<span class="keywordtype">bool</span> compute=<span class="keyword">false</span>) {
00415     compute_covariance = compute;
00416   };
00417 
00426   <span class="keywordtype">bool</span> isCovarianceMatrixComputed() {
00427     <span class="keywordflow">if</span> (compute_covariance == <span class="keyword">true</span>)
00428       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00429     <span class="keywordflow">else</span>
00430       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00431   };
00444   <span class="keywordtype">double</span> *getCovarianceMatrix(<span class="keywordtype">int</span> &amp;n_rows, <span class="keywordtype">int</span> &amp;n_cols){
00445     <span class="keywordflow">if</span> (compute_covariance == <span class="keyword">true</span>) {
00446       n_rows = <a class="code" href="Motion2D_8h.html#a0">MAXCOEFSMODEL</a>;
00447       n_cols = <a class="code" href="Motion2D_8h.html#a0">MAXCOEFSMODEL</a>;
00448       <span class="keywordflow">return</span> covariance;
00449     }
00450     <span class="keywordflow">else</span> {
00451       <span class="comment">// The covariance matrix is not computed</span>
00452       n_rows = -1;
00453       n_cols = -1;
00454       <span class="keywordflow">return</span> NULL;
00455     }
00456   };
00457 
00458   <span class="keywordtype">float</span> *getDisplacedRowsSpatialGradientDataAddress(<span class="keywordtype">int</span> level, <span class="keywordtype">int</span> &amp;n_rows, <span class="keywordtype">int</span> &amp;n_cols);
00459   <span class="keywordtype">float</span> *getDisplacedColsSpatialGradientDataAddress(<span class="keywordtype">int</span> level, <span class="keywordtype">int</span> &amp;n_rows, <span class="keywordtype">int</span> &amp;n_cols);
00460   <span class="keywordtype">float</span> *getDFDDataAddress(<span class="keywordtype">int</span> level, <span class="keywordtype">int</span> &amp;n_rows, <span class="keywordtype">int</span> &amp;n_cols);
00461 
00462 
00463  <span class="keyword">private</span>:
00464   <span class="keywordtype">void</span> __panic(<span class="keywordtype">char</span> *message);
00465 
00467   <span class="comment">// For the estimator tuning.</span>
00469 <span class="comment">  int nrows, ncols;</span>
00470   <span class="keywordtype">int</span> type_variance;    <span class="comment">// Variance given (0), classic (1), robust (2).</span>
00471   <span class="keywordtype">int</span> ty_pond;          <span class="comment">// Weights computation: Tukey(0), Talwar(1),Cauchy(2),</span>
00472                         <span class="comment">// Welsch (3).</span>
00473   <span class="keywordtype">int</span> max_it_stab;      <span class="comment">// Max number of iterations at a given pyramid level</span>
00474   <span class="keywordtype">int</span> max_it_irls;      <span class="comment">// Max number of iterations in the IRLS method.</span>
00475   <span class="keywordtype">double</span> variance;      <span class="comment">// Final value of the C constant</span>
00476   <span class="keywordtype">int</span> level_ct;         <span class="comment">// Input level where constant models are considered.</span>
00477   <span class="keywordtype">int</span> level_lin;        <span class="comment">// Input level where linear models are considered.</span>
00478   <span class="keywordtype">int</span> level_quad;       <span class="comment">// Input level where quadratic models are considered.</span>
00479   <span class="keywordtype">unsigned</span> first_est_level;<span class="comment">// Pyramid level where the estimation starts.</span>
00480   <span class="keywordtype">unsigned</span> final_est_level;<span class="comment">// Pyramid level where the estimation stops</span>
00481   <span class="keywordtype">int</span> pyr_level_max; <span class="comment">// First pyramids level used for motion estimation</span>
00482   <span class="keywordtype">bool</span> compute_sigma2res; <span class="comment">//  If true compute the motion model variance.</span>
00483   <span class="keywordtype">bool</span> compute_covariance; <span class="comment">//  If true compute the covariance matrix</span>
00484   <span class="keywordtype">bool</span> verbose;         <span class="comment">// Verbose mode.</span>
00485 
00486   <span class="keywordtype">double</span> seuil_poids;   <span class="comment">// Threshold to determine if a pixel is conform</span>
00487   <span class="keywordtype">bool</span> least_mean_square;<span class="comment">// If false robust estimation</span>
00488   <span class="keywordtype">double</span> tx_pts_min;    <span class="comment">// Min points requiered at a level</span>
00489 
00490   <span class="keywordtype">bool</span> init_mem_estIsDone;              <span class="comment">// If 1, estimator memory allocated.</span>
00491   <span class="keywordtype">bool</span> init_mem_weightsIsDone;          <span class="comment">// If 1, memory allocated for weighs</span>
00492   TImageFloat pyr_fl1[<a class="code" href="classCMotion2DPyramid.html#s1s0">CMotion2DPyramid::NLEVELS_MAX</a>];   <span class="comment">// Displaced gradients along x.</span>
00493   TImageFloat pyr_fl2[<a class="code" href="classCMotion2DPyramid.html#s1s0">CMotion2DPyramid::NLEVELS_MAX</a>];   <span class="comment">// Displaced gradients along y.</span>
00494   TImageFloat pyr_fl3[<a class="code" href="classCMotion2DPyramid.html#s1s0">CMotion2DPyramid::NLEVELS_MAX</a>];   <span class="comment">// DFD: I(pi+depl,t+1)-I(pi,t).</span>
00495   TImageFloat pyr_weights[<a class="code" href="classCMotion2DPyramid.html#s1s0">CMotion2DPyramid::NLEVELS_MAX</a>];<span class="comment">// Weights pyramid</span>
00496   TImageShort pyr_support[<a class="code" href="classCMotion2DPyramid.html#s1s0">CMotion2DPyramid::NLEVELS_MAX</a>];<span class="comment">// Support pyramid</span>
00497   <span class="keywordtype">int</span> ct_level_intro;   <span class="comment">// Level where constant models were considered</span>
00498   <span class="keywordtype">int</span> lin_level_intro;  <span class="comment">// Level where linear models were considered.</span>
00499   <span class="keywordtype">int</span> quad_level_intro; <span class="comment">// Level where quadratic models were considered.</span>
00500   <span class="keywordtype">int</span> compute_support_size; <span class="comment">// If true, compute the normalized ratio between</span>
00501                         <span class="comment">// pixels considered as conform to the dominant</span>
00502                         <span class="comment">// motion and the size of of the part of I(t) that is</span>
00503                         <span class="comment">// likely to overlap I(t+1).</span>
00504   <span class="keywordtype">double</span> rapport_poids; <span class="comment">// Normalized ratio (see compute_support_size)</span>
00505   <span class="keywordtype">double</span> sigma2res;     <span class="comment">// Residual variance.</span>
00506   <span class="keywordtype">double</span> covariance[<a class="code" href="Motion2D_8h.html#a0">MAXCOEFSMODEL</a> * <a class="code" href="Motion2D_8h.html#a0">MAXCOEFSMODEL</a>];     <span class="comment">// Covariance matrix</span>
00507 
00508 };
00509 
00510 
00511 <span class="preprocessor">#endif</span>
</pre></div><hr> 
<address><small>Motion2D is Copyright &copy; 1995-2005 by <a href="http://www.inria.fr/index.en.html">Inria</a></small></address>
<address><small>This documentation was generated on 31 Jan 2005 by Fabien Spindler for 
Motion2D 1.3.11 using <a href="http://www.doxygen.org/index.html"> 
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=77 height=37></a>1.2.18 written by <a href="mailto:dimitri@stack.nl">Dimitri 
van Heesch</a>, &copy;&nbsp;1997-2005</small></address>
</body>
</html>
