<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<title>Motion2D: a software to estimate 2D parametric motion models</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta content="Motion2D: dominant motion estimation" name=description>
<meta content="Motion2D,motion estimation,motion models,image processing" 
name=KeyWords>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>

<center>
<a href="http://www.irisa.fr/vista/Vista.english.html"><img src="logo-vista3.gif" alt="Vista" align=middle border=0></a> &nbsp;&nbsp;&nbsp;

<a href="index.html">Main Page</a> &nbsp;

<a href="annotated.html">Class List</a> &nbsp;

<a href="functions.html">Function List</a> &nbsp;

<a href="files.html">File List</a> &nbsp;

<a href="examples.html">Examples</a> &nbsp;
</center>

<hr>
<br>
<!-- Generated by Doxygen 1.2.18 -->
<h1>Warping.cpp</h1>
<p>
<h1>Example of warped images generation.</h1><br>

<p>
This example shows how to generate warped images using a 2D affine motion model.
<p>
To get help or to see the available options try: <div class="fragment"><pre> 
  ./Warping -?
  </pre></div>
<p>
To generate a synthetic sequence based on warping image 20 and 21 of the round-about sequence by using an affine motion model specified for these two images in ../../test/motion/model.txt try:
<p>
<div class="fragment"><pre> 
  cp ../../test/sequence/png/rond-point002{0,1}.png /tmp
  ./Warping -p /tmp/rond-point%04d.png -f 20 -i 2 -m ../../test/motion/model.txt -w /tmp/warped%02d.png -v
  </pre></div>
<p>
The warped images are available in /tmp/warped20.png and /tmp/warped20.png
<p>
<hr>
<p>
Main:
<p>
<div class="fragment"><pre><span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Copyright (c) 1995-2005 by INRIA.</span>
<span class="comment">  All Rights Reserved.</span>
<span class="comment"></span>
<span class="comment">  This software was developed at:</span>
<span class="comment">  IRISA/INRIA Rennes</span>
<span class="comment">  Campus Universitaire de Beaulieu</span>
<span class="comment">  35042 Rennes Cedex</span>
<span class="comment"></span>
<span class="comment">  http://www.irisa.fr</span>
<span class="comment"></span>
<span class="comment">*/</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#ifdef __SunOS_</span>
<span class="preprocessor"></span><span class="preprocessor"># include &lt;iostream.h&gt;</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor"># include &lt;iostream&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;ctype.h&gt;</span>
<span class="preprocessor">#include &lt;string&gt;</span>

<span class="comment">// Includes lies a Motion2D</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMotion2DImage_8h.html">CMotion2DImage.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMotion2DModel_8h.html">CMotion2DModel.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMotion2DWarping_8h.html">CMotion2DWarping.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CReader_8h.html">CReader.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CImageReader_8h.html">CImageReader.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMpeg2Reader_8h.html">CMpeg2Reader.h</a>&gt;</span>
<span class="preprocessor">#include "<a class="code" href="CImageWriter_8h.html">CImageWriter.h</a>"</span>
<span class="preprocessor">#include "../src/inc/type.h"</span>
<span class="preprocessor">#include "../src/compense/compense.h"</span>

<span class="keyword">using</span> <span class="keyword">namespace </span>std;

<span class="preprocessor">#define GETOPTARGS      "f:hi:m:p:s:vw:?"</span>
<span class="preprocessor"></span><span class="preprocessor">#define max(a,b) (a&gt;b?a:b)</span>
<span class="preprocessor"></span>
<span class="keywordtype">bool</span> <a name="a0"></a><a class="code" href="CMotion2D_8cpp.html#a0">findChar</a>(string ch, <span class="keywordtype">char</span> *f)
{
  <span class="keywordtype">int</span> n = ch.find(f);
  <span class="keywordtype">int</span> size = ch.size();
  <span class="keywordflow">return</span> (n&gt;0 &amp;&amp; n&lt;size);
};

<span class="keywordtype">int</span>  getoption (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv, <span class="keywordtype">char</span>* pszValidOpts, <span class="keywordtype">char</span>** ppszParam);
<span class="keywordtype">void</span> getoptions(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv,
                string &amp;ipath, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> &amp;frame,
                <span class="keywordtype">int</span> &amp;step, <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> &amp;niter,
                string &amp;mfile, string &amp;wpath, <span class="keywordtype">bool</span> &amp;verbose);
<span class="keywordtype">void</span> usage(<span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *badparam);
<span class="keywordtype">bool</span> readModel(string filename, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> frame, <a name="_a1"></a><a class="code" href="classCMotion2DModel.html">CMotion2DModel</a> &amp;model);

<span class="preprocessor">#define DEBUG_LEVEL1 0</span>
<span class="preprocessor"></span><span class="preprocessor">#define DEBUG_LEVEL2 0</span>
<span class="preprocessor"></span>

<span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Robust multiresolution estimation of parametric motion model.</span>
<span class="comment"></span>
<span class="comment">*/</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{
  <a name="_a2"></a><a class="code" href="classCMotion2DImage.html">CMotion2DImage&lt;unsigned char&gt;</a> I;      <span class="comment">// Image</span>
  <a class="code" href="classCMotion2DImage.html">CMotion2DImage&lt;unsigned char&gt;</a> W;      <span class="comment">// M-estimator weights image</span>
  <a class="code" href="classCMotion2DModel.html">CMotion2DModel</a>        model;          <span class="comment">// Parametric motion model</span>
  <a name="_a3"></a><a class="code" href="classCMotion2DWarping.html">CMotion2DWarping</a>      warping;        <span class="comment">// Warping</span>
  <a name="_a4"></a><a class="code" href="classCReader.html">CReader</a>               *Ireader=NULL;  <span class="comment">// Image reader</span>
  <a name="_a5"></a><a class="code" href="classCImageReader.html">CImageReader</a>          imgr;           <span class="comment">// PNM or PNG image reader</span>
  <a name="_a6"></a><a class="code" href="classCMpeg2Reader.html">CMpeg2Reader</a>          mpegr;          <span class="comment">// Mpeg2 image decoder</span>
  <a name="_a7"></a><a class="code" href="classCWriter.html">CWriter</a>               *Wwriter=NULL;  <span class="comment">// Image writer</span>
  <a name="_a8"></a><a class="code" href="classCImageWriter.html">CImageWriter</a>          imgw;           <span class="comment">// PNM or PNG image writer</span>

  string ipath = <span class="stringliteral">"../../test/sequence/rond-point"</span>; <span class="comment">// Image path</span>
  string filename;              <span class="comment">// Complete filename for an image of the video</span>
  string mfile;                 <span class="comment">// Motion model filename</span>
  string wpath;                 <span class="comment">// Warped image path</span>
  <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> niter = 33;     <span class="comment">// Number of images to process</span>
  <span class="keywordtype">int</span>  step = 1;                <span class="comment">// Step between 2 images</span>
  <span class="keywordtype">bool</span> verbose = <span class="keyword">false</span>;         <span class="comment">// Verbose mode</span>
  <span class="keywordtype">bool</span> ierr = <span class="keyword">true</span>;             <span class="comment">// Image IO return value</span>
  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> frame  = 1; <span class="comment">// Current frame number to process</span>

  <span class="comment">// Read the program options</span>
  getoptions(argc, argv, ipath, frame, step, niter,
             mfile, wpath, verbose);

  <span class="comment">// Set the image reader format by regarding the image extension</span>
  <span class="keywordflow">if</span> (<a class="code" href="CMotion2D_8cpp.html#a0">findChar</a>(ipath, _mpg) || <a class="code" href="CMotion2D_8cpp.html#a0">findChar</a>(ipath, _mpeg)) {
    cout &lt;&lt; <span class="stringliteral">"Reader mpeg\n"</span>;
    Ireader = &amp;mpegr;
  }
  <span class="keywordflow">else</span> {
    cout &lt;&lt; <span class="stringliteral">"Reader PNM\n"</span>;
    Ireader = &amp;imgr;
  }

  Ireader-&gt;<a name="a9"></a><a class="code" href="classCReader.html#a2">setFileName</a>(ipath);
  Ireader-&gt;<a name="a10"></a><a class="code" href="classCReader.html#a4">setFrameNumber</a>(frame);
  filename = Ireader-&gt;<a name="a11"></a><a class="code" href="classCReader.html#a6">getFileName</a>();

  <span class="keywordflow">if</span> (!Ireader-&gt;<a name="a12"></a><a class="code" href="classCReader.html#a9">openStream</a>()) {
    cout &lt;&lt;<span class="stringliteral">"Can't open stream "</span>&lt;&lt; ipath &lt;&lt;endl;
    exit(-1);
  }

  <span class="comment">// Set the image writer</span>
  Wwriter = &amp;imgw;

  <span class="comment">// Start the warping loop</span>
  <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> i=0;
  <span class="keywordflow">do</span> {

    <span class="comment">// Load the image</span>
    Ireader-&gt;<a class="code" href="classCReader.html#a2">setFileName</a>(ipath);
    Ireader-&gt;<a class="code" href="classCReader.html#a4">setFrameNumber</a>(frame);
    filename = Ireader-&gt;<a class="code" href="classCReader.html#a6">getFileName</a>();
    <span class="keywordflow">if</span> (verbose)
      cout &lt;&lt; <span class="stringliteral">"Load image: "</span> &lt;&lt; filename &lt;&lt; endl ;
    ierr = Ireader-&gt;<a name="a13"></a><a class="code" href="classCReader.html#a7">getFrame</a>(I);
    <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
      cout &lt;&lt; <span class="stringliteral">"Can not read the image: "</span> &lt;&lt; filename &lt;&lt; endl;
      exit(-1);
    }

    <span class="keywordflow">if</span> (readModel(mfile, frame, model) == <span class="keyword">false</span>)
      exit(0);

    <span class="keywordflow">if</span> (verbose) {
      <span class="keywordtype">double</span> row, col;
      <span class="keywordtype">double</span> p[<a class="code" href="classCMotion2DModel.html#s1s0">CMotion2DModel::MDL_NMAX_COEF</a>]; <span class="comment">// model parameters</span>
      model.<a name="a14"></a><a class="code" href="classCMotion2DModel.html#a21">getOrigin</a>(row, col);
      model.<a name="a15"></a><a class="code" href="classCMotion2DModel.html#a11">getParameters</a>(p);
      cout &lt;&lt; <span class="stringliteral">"Warp image: "</span> &lt;&lt; filename.c_str() &lt;&lt; endl;
      cout &lt;&lt; <span class="stringliteral">"\tMotion model: "</span> &lt;&lt; model.<a name="a16"></a><a class="code" href="classCMotion2DModel.html#a14">idToString</a>() &lt;&lt; endl;
      cout &lt;&lt; <span class="stringliteral">"\t  origin: "</span> &lt;&lt; row &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; col &lt;&lt; endl;
      cout &lt;&lt; <span class="stringliteral">"\t  x: "</span> &lt;&lt; p[0] &lt;&lt;<span class="stringliteral">" | "</span> &lt;&lt; p[2] &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; p[3] &lt;&lt; <span class="stringliteral">" | "</span>
           &lt;&lt; p[6] &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; p[7] &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; p[8] &lt;&lt; endl;
      cout &lt;&lt; <span class="stringliteral">"\t  y: "</span> &lt;&lt; p[1] &lt;&lt;<span class="stringliteral">" | "</span> &lt;&lt; p[4] &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; p[5] &lt;&lt; <span class="stringliteral">" | "</span>
           &lt;&lt; p[9] &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; p[10] &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; p[11] &lt;&lt; endl;
    }

    <span class="comment">// Initialize the warped image size</span>
    W.<a name="a17"></a><a class="code" href="classCMotion2DImage.html#a5">Init</a>(I.<a name="a18"></a><a class="code" href="classCMotion2DImage.html#a12">GetRows</a>(), I.<a name="a19"></a><a class="code" href="classCMotion2DImage.html#a13">GetCols</a>());

    <span class="comment">// warp the input image</span>
    warping.<a name="a20"></a><a class="code" href="classCMotion2DWarping.html#a6">warp</a>(I.<a name="a21"></a><a class="code" href="classCMotion2DImage.html#m0">bitmap</a>, W.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>, I.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>(), I.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>(), model);

    <span class="comment">// Construct the backwarped image filename</span>
    Wwriter-&gt;<a name="a22"></a><a class="code" href="classCWriter.html#a2">setFileName</a>(wpath);
    Wwriter-&gt;<a name="a23"></a><a class="code" href="classCWriter.html#a4">setFrameNumber</a>(frame);
    filename = Wwriter-&gt;<a name="a24"></a><a class="code" href="classCWriter.html#a6">getFileName</a>();
    <span class="keywordflow">if</span> (verbose)
      cout &lt;&lt; <span class="stringliteral">"\tWrite warped image: "</span> &lt;&lt; filename &lt;&lt; endl ;
    ierr = Wwriter-&gt;<a name="a25"></a><a class="code" href="classCWriter.html#a7">writeFrame</a>(W);    <span class="comment">// Write the backwarped image</span>
    <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
      cout &lt;&lt; <span class="stringliteral">"Can not write the backwarped image: "</span> &lt;&lt; filename &lt;&lt; endl;
      exit(-1);
    }

    frame += step; <span class="comment">// Update the image frame number</span>

  } <span class="keywordflow">while</span> (++i &lt; niter);

  Ireader-&gt;<a name="a26"></a><a class="code" href="classCReader.html#a10">closeStream</a>();

  <span class="keywordflow">return</span> 0;
}



<span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Print the program options.</span>
<span class="comment"></span>
<span class="comment"> */</span>
<span class="keywordtype">void</span> usage(<span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *badparam)
{
  <span class="keywordflow">if</span> (badparam)
    fprintf(stderr, <span class="stringliteral">"\nBad parameter [%s]\n"</span>, badparam);

  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  Copyright (c) 1995-2005 by INRIA.\n\</span>
<span class="stringliteral">  All Rights Reserved.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  This software was developed at:\n\</span>
<span class="stringliteral">  IRISA/INRIA Rennes\n\</span>
<span class="stringliteral">  Campus Universitaire de Beaulieu \n\</span>
<span class="stringliteral">  35042 Rennes Cedex\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  http://www.irisa.fr\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">SYNOPSIS\n\</span>
<span class="stringliteral">  %s [-p image_path] [-e image_extension] [-f first_frame]\n\</span>
<span class="stringliteral">  [-s step] [-i iterations] [-m model_filename] [-w warped_image_path]\n\</span>
<span class="stringliteral">  [-v] [-h] [-?]\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">DESCRIPTION\n\</span>
<span class="stringliteral">  This software generates warped images using a parametric motion model.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">\n"</span>, name);

<span class="preprocessor">#ifndef __NO_IMAGEIO_PNG_</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\</span>
<span class="stringliteral">INPUT SEQUENCE OPTIONS:                                       Default\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -p image_path [%%s]                  ../../test/sequence/rond-point\n\</span>
<span class="stringliteral">     Specify the path and the generic name of the files \n\</span>
<span class="stringliteral">     containing the images to process. The following image\n\</span>
<span class="stringliteral">     file formats PNG and PNM are supported. The different\n\</span>
<span class="stringliteral">     PNM formats are PGM (P5) and PPM (P6).\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -e image_extension [%%s]                                       .pgm\n\</span>
<span class="stringliteral">     Specify the image extension. Supported image formats \n\</span>
<span class="stringliteral">     are PNG (use -e .png), PGM P5 (use -e .pgm) and PPM P6\n\</span>
<span class="stringliteral">     (use -e .ppm). \n\</span>
<span class="stringliteral">\n"</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\</span>
<span class="stringliteral">INPUT SEQUENCE OPTIONS:                                       Default\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -p image_path [%%s]                  ../../test/sequence/rond-point\n\</span>
<span class="stringliteral">     Specify the path and the generic name of the files \n\</span>
<span class="stringliteral">     containing the images to process. Only the PNM formats \n\</span>
<span class="stringliteral">     PGM (P5) and PPM (P6) are supported.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -e image_extension [%%s]                                       .pgm\n\</span>
<span class="stringliteral">     Specify the image extension. Supported image formats \n\</span>
<span class="stringliteral">     are PGM P5 (use -e .pgm) and PPM P6 (use -e .ppm). \n\</span>
<span class="stringliteral">\n"</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  fprintf(stdout, <span class="stringliteral">"\</span>
<span class="stringliteral">  -f first_frame [%%s]                                           0001\n\</span>
<span class="stringliteral">     Specify the number of the first frame in the video \n\</span>
<span class="stringliteral">     sequence. If the image sequence numbering uses a fixed \n\</span>
<span class="stringliteral">     number of digits, complete whith 0 before the image number.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -s step [%%d]                                                     1\n\</span>
<span class="stringliteral">     Specify the step between two frames in the video sequence.\n\</span>
<span class="stringliteral">     If step &gt; 0 images are processed forward. If step &lt; 0 images\n\</span>
<span class="stringliteral">     are processed backward.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -i iterations [%%lu]                                             33\n\</span>
<span class="stringliteral">     Specify the number of motion estimation iterations to\n\</span>
<span class="stringliteral">     process. The number of the last image computed is given by:\n\</span>
<span class="stringliteral">     first_frame + iterations * step.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -m model_filename [%%s]                       \n\</span>
<span class="stringliteral">     Specify the name of the file containing the values of the\n\</span>
<span class="stringliteral">     parametric motion model coefficients.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">RESULTS OPTIONS:\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -w warped_image_path [%%s]                           \n\</span>
<span class="stringliteral">     Specify the path and the generic name of the files contain-\n\</span>
<span class="stringliteral">     ing the back-warped images built using the estimated motion\n\</span>
<span class="stringliteral">     model. The generated images format depends on the treated  \n\</span>
<span class="stringliteral">     image extension specified by option -e.\n\</span>
<span class="stringliteral">\n"</span>);

  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">OTHER OPTIONS:\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -v\n\</span>
<span class="stringliteral">     Activate the verbose mode.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -h\n\</span>
<span class="stringliteral">     Print the help.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -?\n\</span>
<span class="stringliteral">     Print the help.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">\n"</span>);

  exit(0);
}

<span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Set the program options.</span>
<span class="comment"></span>
<span class="comment">*/</span>
<span class="keywordtype">void</span> getoptions(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv,
                string &amp;ipath, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> &amp;frame,
                <span class="keywordtype">int</span> &amp;step, <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> &amp;niter,
                string &amp;mfile, string &amp;wpath, <span class="keywordtype">bool</span> &amp;verbose)
{
  <span class="keywordtype">char</span> *optarg;
  <span class="keywordtype">int</span>   c;
  <span class="keywordflow">while</span> ((c = getoption(argc, argv, GETOPTARGS, &amp;optarg)) &gt; 1) {

    <span class="keywordflow">switch</span> (c) {
    <span class="keywordflow">case</span> <span class="charliteral">'f'</span>: frame = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'h'</span>: usage(argv[0], NULL); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'i'</span>: niter = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'m'</span>: mfile = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'p'</span>: ipath = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'s'</span>: step = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'v'</span>: verbose = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'w'</span>: wpath = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'?'</span>: usage(argv[0], NULL); <span class="keywordflow">break</span>;

    <span class="keywordflow">default</span>:  usage(argv[0], NULL); <span class="keywordflow">break</span>;
    }
  }

  <span class="comment">// Some option tests</span>
  <span class="keywordflow">if</span> (wpath.empty()) {
    <span class="comment">// standalone param or error</span>
    fprintf(stderr, <span class="stringliteral">"Option -w [warped_image_path] not specified\n"</span>);
    usage(argv[0], NULL);
    exit(0);


  }
  <span class="keywordflow">if</span> ((c == 1) || (c == -1)) {
    <span class="comment">// standalone param or error</span>
    fprintf(stderr, <span class="stringliteral">"Bad argument %s\n"</span>, optarg);

    usage(argv[0], NULL);

    exit(0);
  }

  <span class="keywordflow">if</span> ( mfile.empty() ) {
    cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">"Error: argument -m &lt;filename&gt; not specified "</span> &lt;&lt; endl;
    exit(0);
  }
  <span class="keywordflow">else</span> {
    FILE *fd = fopen(mfile.c_str(), <span class="stringliteral">"rb"</span>);
    <span class="keywordflow">if</span> (fd == NULL) {
      cout &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"Bad argument -m: "</span>
           &lt;&lt; <span class="stringliteral">"Cannot open the filename specified "</span>
           &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"with this option."</span>
           &lt;&lt; endl;
      exit(0);
    }
    fclose(fd);
  }
}

<span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Get next command line option and parameter</span>
<span class="comment"></span>
<span class="comment">  PARAMETERS:</span>
<span class="comment"></span>
<span class="comment">      argc - count of command line arguments</span>
<span class="comment">      argv - array of command line argument strings</span>
<span class="comment">      pszValidOpts - string of valid, case-sensitive option characters,</span>
<span class="comment">                     a colon ':' following a given character means that</span>
<span class="comment">                     option can take a parameter</span>
<span class="comment">      ppszParam - pointer to a pointer to a string for output</span>
<span class="comment"></span>
<span class="comment">  RETURNS:</span>
<span class="comment"></span>
<span class="comment">      If valid option is found, the character value of that option</span>
<span class="comment">          is returned, and *ppszParam points to the parameter if given,</span>
<span class="comment">          or is NULL if no param</span>
<span class="comment">      If standalone parameter (with no option) is found, 1 is returned,</span>
<span class="comment">          and *ppszParam points to the standalone parameter</span>
<span class="comment">      If option is found, but it is not in the list of valid options,</span>
<span class="comment">          -1 is returned, and *ppszParam points to the invalid argument</span>
<span class="comment">      When end of argument list is reached, 0 is returned, and</span>
<span class="comment">          *ppszParam is NULL</span>
<span class="comment">*/</span>
<span class="keywordtype">int</span> getoption (
    <span class="keywordtype">int</span> argc,
    <span class="keywordtype">char</span>** argv,
    <span class="keywordtype">char</span>* pszValidOpts,
    <span class="keywordtype">char</span>** ppszParam)
{
  <span class="keyword">static</span> <span class="keywordtype">int</span> iArg = 1;
  <span class="keywordtype">int</span> chOpt;
  <span class="keywordtype">char</span>* psz = NULL;
  <span class="keywordtype">char</span>* pszParam = NULL;

  <span class="keywordflow">if</span> (iArg &lt; argc) {
    psz = &amp;(argv[iArg][0]);
    <span class="keywordflow">if</span> (*psz == <span class="charliteral">'-'</span>) { <span class="comment">// || *psz == '/')  {</span>
      <span class="comment">// we have an option specifier</span>
      chOpt = argv[iArg][1];
      <span class="keywordflow">if</span> (isalnum(chOpt) || ispunct(chOpt)) {
        <span class="comment">// we have an option character</span>
        psz = strchr(pszValidOpts, chOpt);
        <span class="keywordflow">if</span> (psz != NULL) {
          <span class="comment">// option is valid, we want to return chOpt</span>
          <span class="keywordflow">if</span> (psz[1] == <span class="charliteral">':'</span>) {
            <span class="comment">// option can have a parameter</span>
            psz = &amp;(argv[iArg][2]);
            <span class="keywordflow">if</span> (*psz == <span class="charliteral">'\0'</span>) {
              <span class="comment">// must look at next argv for param</span>
              <span class="keywordflow">if</span> (iArg+1 &lt; argc) {
                psz = &amp;(argv[iArg+1][0]);
                <span class="comment">// next argv is the param</span>
                iArg++;
                pszParam = psz;
              }
              <span class="keywordflow">else</span> {
                <span class="comment">// reached end of args looking for param</span>
              }

            }
            <span class="keywordflow">else</span> {
              <span class="comment">// param is attached to option</span>
              pszParam = psz;
            }
          }
          <span class="keywordflow">else</span> {
            <span class="comment">// option is alone, has no parameter</span>
          }
        }
        <span class="keywordflow">else</span> {
          <span class="comment">// option specified is not in list of valid options</span>
          chOpt = -1;
          pszParam = &amp;(argv[iArg][0]);
        }
      }
      <span class="keywordflow">else</span> {
        <span class="comment">// though option specifier was given, option character</span>
        <span class="comment">// is not alpha or was was not specified</span>
        chOpt = -1;
        pszParam = &amp;(argv[iArg][0]);
      }
    }
    <span class="keywordflow">else</span> {
      <span class="comment">// standalone arg given with no option specifier</span>
      chOpt = 1;
      pszParam = &amp;(argv[iArg][0]);
    }
  }
  <span class="keywordflow">else</span> {
    <span class="comment">// end of argument list</span>
    chOpt = 0;
  }

  iArg++;
  *ppszParam = pszParam;
  <span class="keywordflow">return</span> (chOpt);
}

<span class="keywordtype">bool</span> readModel(string filename, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> frame, <a class="code" href="classCMotion2DModel.html">CMotion2DModel</a> &amp;model)
{
<span class="preprocessor">#define MAX_LEN 512</span>
<span class="preprocessor"></span>
  FILE *fd = NULL;
  <span class="keywordtype">char</span>  str[MAX_LEN];
  <span class="keywordtype">int</span>   line;
  <span class="keywordtype">char</span>* cerr;
  <span class="keywordtype">int</span>   ierr;

  <span class="keywordflow">if</span> ( filename.empty() ) {
    fprintf(stderr, <span class="stringliteral">"Error in readModel: no filename\n"</span>);
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
  }

  fd = fopen(filename.c_str(), <span class="stringliteral">"rb"</span>);
  <span class="keywordflow">if</span> (fd == NULL) {
    fprintf(stderr, <span class="stringliteral">"Error in readModel: couldn't read file %s\n"</span>,
            filename.c_str());
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
  }

  <span class="comment">// Jump the possible comment, or empty line and read the following line</span>
  line = 0;
  <span class="keywordflow">do</span> {
    cerr = fgets(str, MAX_LEN - 1, fd);

    line++;
    <span class="keywordflow">if</span> (cerr == NULL) {
      fprintf(stderr, <span class="stringliteral">"Error in readModel: couldn't read line %d of file %s\n"</span>,
              line, filename.c_str());
      fclose (fd);
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }
  } <span class="keywordflow">while</span> ((str[0] == <span class="charliteral">'#'</span>) || (str[0] == <span class="charliteral">'\n'</span>));

  <span class="comment">// Extract model id</span>
  <span class="keywordtype">char</span> _text[255];
  <span class="keywordtype">char</span> _egal[255];
  <span class="keywordtype">char</span> _id[255];
  string s = str;
  ierr = s.find(<span class="stringliteral">"MODEL_ID"</span>);
  <span class="keywordflow">if</span> (ierr != -1) {
    ierr = sscanf(str, <span class="stringliteral">"%s %s %s"</span>, _text, _egal, _id);
    <span class="comment">//    printf("text: %s\n", _text);</span>
    <span class="comment">//   printf("_egal: %s\n", _egal);</span>
    <span class="comment">//  printf("_id: %s\n", _id);</span>
  }
  <span class="keywordflow">else</span> {
     ierr = sscanf(str, <span class="stringliteral">"%s"</span>, _id);
  }

  <span class="keywordflow">if</span> (ierr == EOF) {
    fprintf(stderr,
            <span class="stringliteral">"Error in readModel: premature EOF on line %d of file %s\n"</span>,
            line, filename.c_str());
    fclose (fd);
    <span class="keywordflow">return</span> <span class="keyword">false</span>;
  }

  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> _frame;
  <span class="keywordtype">double</span> _row, _col; <span class="comment">// model origin</span>
  <span class="keywordtype">double</span> _p[<a class="code" href="classCMotion2DModel.html#s1s0">CMotion2DModel::MDL_NMAX_COEF</a>]; <span class="comment">// model parameters</span>
  <span class="keywordtype">double</span> _multfactor = 1.0;
  <span class="keywordtype">bool</span> multfactor_was_read = <span class="keyword">false</span>;

  <span class="keywordflow">do</span> {
    <span class="comment">// Read a line</span>
    cerr = fgets(str, MAX_LEN - 1, fd);
    <span class="comment">//printf("line2: %s\n", str);</span>
    line ++;
    <span class="keywordflow">if</span> (cerr == NULL) {
      fprintf(stderr, <span class="stringliteral">"Error in readModel: couldn't read line %d of file %s\n"</span>,
              line, filename.c_str());
      fclose (fd);
      <span class="keywordflow">return</span> <span class="keyword">false</span>;
    }

    <span class="comment">// Get the multiplier factor if it exists</span>
    <span class="keywordflow">if</span> (multfactor_was_read == <span class="keyword">false</span>) {
      s = str;
      ierr = s.find(<span class="stringliteral">"MULTIPLIER_FACTOR"</span>);
      multfactor_was_read = <span class="keyword">true</span>;
      <span class="keywordflow">if</span> (ierr != -1) {
        ierr = sscanf(str, <span class="stringliteral">"%s %s %lf"</span>, _text, _egal, &amp;_multfactor);
        cout &lt;&lt; <span class="stringliteral">"multfactor: "</span> &lt;&lt; _multfactor &lt;&lt; endl;
        <span class="keywordflow">if</span> (ierr == EOF) {
          fprintf(stderr,
                  <span class="stringliteral">"Error in readModel: premature EOF on line %d of file %s\n"</span>,
                  line, filename.c_str());
          fclose (fd);
          <span class="keywordflow">return</span> <span class="keyword">false</span>;
        }
        <span class="keywordflow">continue</span>;
      }
    }

    <span class="comment">// Extract information</span>
    ierr = sscanf(str,
                  <span class="stringliteral">"%ld %lf %lf %lf %lf %lf %lf %lf %lf %lf %lf %lf %lf %lf %lf"</span>,
                  &amp;_frame, &amp;_row, &amp;_col,
                  &amp;_p[0], &amp;_p[1], <span class="comment">// c1, c2</span>
                  &amp;_p[2], &amp;_p[3], &amp;_p[4], &amp;_p[5], <span class="comment">//a1, a2, a3, a4</span>
                  &amp;_p[6], &amp;_p[7], &amp;_p[8], &amp;_p[9], &amp;_p[10], &amp;_p[11]); <span class="comment">//q1...q6</span>
    <span class="keywordflow">if</span> (ierr == EOF) {
      fprintf(stderr,
              <span class="stringliteral">"Error in readModel: premature EOF on line %d of file %s\n"</span>,
              line, filename.c_str());
      fclose (fd);
      <span class="keywordflow">return</span> <span class="keyword">false</span>;

    }
  } <span class="keywordflow">while</span> (frame != _frame);

  <span class="comment">// rescale the parameters</span>
  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classCMotion2DModel.html#s1s0">CMotion2DModel::MDL_NMAX_COEF</a>; i ++) {
    _p[i] /= _multfactor;
  }

  string id = _id;

  model.<a name="a27"></a><a class="code" href="classCMotion2DModel.html#a12">reset</a>();        <span class="comment">// Set all the parameters to zero</span>
  model.<a name="a28"></a><a class="code" href="classCMotion2DModel.html#a4">setIdModel</a>(id); <span class="comment">// Set the model id</span>
  model.<a name="a29"></a><a class="code" href="classCMotion2DModel.html#a6">setVarLight</a>(<span class="keyword">false</span>); <span class="comment">// Set the illumination variation</span>
  model.<a name="a30"></a><a class="code" href="classCMotion2DModel.html#a3">setOrigin</a>(_row, _col); <span class="comment">// Set the origin</span>
  model.<a name="a31"></a><a class="code" href="classCMotion2DModel.html#a7">setParameters</a>(_p);

  fclose (fd);

  <span class="keywordflow">return</span> <span class="keyword">true</span>;

<span class="preprocessor">#undef MAX_LEN</span>
<span class="preprocessor"></span>}


</pre></div><hr> 
<address><small>Motion2D is Copyright &copy; 1995-2005 by <a href="http://www.inria.fr/index.en.html">Inria</a></small></address>
<address><small>This documentation was generated on 31 Jan 2005 by Fabien Spindler for 
Motion2D 1.3.11 using <a href="http://www.doxygen.org/index.html"> 
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=77 height=37></a>1.2.18 written by <a href="mailto:dimitri@stack.nl">Dimitri 
van Heesch</a>, &copy;&nbsp;1997-2005</small></address>
</body>
</html>
