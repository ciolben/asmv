<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
<title>Motion2D: a software to estimate 2D parametric motion models</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<meta content="Motion2D: dominant motion estimation" name=description>
<meta content="Motion2D,motion estimation,motion models,image processing" 
name=KeyWords>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>

<center>
<a href="http://www.irisa.fr/vista/Vista.english.html"><img src="logo-vista3.gif" alt="Vista" align=middle border=0></a> &nbsp;&nbsp;&nbsp;

<a href="index.html">Main Page</a> &nbsp;

<a href="annotated.html">Class List</a> &nbsp;

<a href="functions.html">Function List</a> &nbsp;

<a href="files.html">File List</a> &nbsp;

<a href="examples.html">Examples</a> &nbsp;
</center>

<hr>
<br>
<!-- Generated by Doxygen 1.2.18 -->
<h1>Motion2D.cpp</h1>
<p>
<h1>Example of 2D parametric motion models estimation. </h1><br>

<p>
This example shows how to use the Motion2D library to generate the Motion2D binary able to estimate 2D parametric motion models between two successive images of a video sequence. It can handle several types of motion models, respectively, constant model (translation), affine, and quadratic models. Moreover, it integrates the possibility of taking into account the global variation of illumination.
<p>

  The Motion2D binary user manual is available here: <a href=http://www.irisa.fr/vista/Motion2D/publications/usermanual.pdf>usermanual.pdf</a>
  
<p>

<p>
To get help or to see the available options try: <div class="fragment"><pre> 
  ./Motion2D -?
  </pre></div>
<p>
To estimate the dominant 2D affine motion model between each couple of images of the round-about sequence in Mpeg2 format and put the results in the /tmp/result.txt file try:
<p>
<div class="fragment"><pre> 
  ./Motion2D -m AC -p ../../test/sequence/mpeg2/rond-point.mpg -f 0 -i 31 -r /tmp/result.txt -v 
  </pre></div>
<p>
To estimate the dominant 2D affine motion model between each couple of images of the round-about sequence in PNG format and put the results in the /tmp/result.txt file try:
<p>
<div class="fragment"><pre> 
  ./Motion2D -m AC -p ../../test/sequence/png/rond-point%04d.png -f 1 -i 33 -r /tmp/result.txt -v 
  </pre></div>
<p>
To estimate the dominant motion using a quadratic motion model between each couple of images of the round-about sequence in png format and generate a back-warped sequence in PGM P5 format try:
<p>
<div class="fragment"><pre> 
  ./Motion2D -m QPTD -p ../../test/sequence/ppm/rond-point%04d.png -f 1 -i 33 -b /tmp/bwarp%04d.pgm -j 264 -k 450 -t -30 -u -20 -v
  </pre></div>
<p>
To estimate the motion of the mobile vehicle in the round-about sequence in PNG format using a quadratic motion model and an input estimation support sequence in PNG format too try:
<p>
<div class="fragment"><pre> 
  ./Motion2D -m QC -p ../../test/sequence/png/rond-point%04d.png -f 1 -i 33 -a ../../test/sequence/png/support%04d.png -c 255 -v
  </pre></div>
<p>
<hr>
<p>
Main:
<p>
<div class="fragment"><pre><span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Copyright (c) 1995-2005 by INRIA.</span>
<span class="comment">  All Rights Reserved.</span>
<span class="comment"></span>
<span class="comment">  This software was developed at:</span>
<span class="comment">  IRISA/INRIA Rennes</span>
<span class="comment">  Campus Universitaire de Beaulieu</span>
<span class="comment">  35042 Rennes Cedex</span>
<span class="comment"></span>
<span class="comment">  http://www.irisa.fr</span>
<span class="comment"></span>
<span class="comment">*/</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#ifdef __SunOS_</span>
<span class="preprocessor"></span><span class="preprocessor"># include &lt;iostream.h&gt;</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor"># include &lt;iostream&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;ctype.h&gt;</span>
<span class="preprocessor">#include &lt;string&gt;</span>

<span class="comment">// Include for Motion2D</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMotion2DImage_8h.html">CMotion2DImage.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMotion2DEstimator_8h.html">CMotion2DEstimator.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMotion2DPyramid_8h.html">CMotion2DPyramid.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMotion2DModel_8h.html">CMotion2DModel.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMotion2DWarping_8h.html">CMotion2DWarping.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CReader_8h.html">CReader.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CImageReader_8h.html">CImageReader.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CMpeg2Reader_8h.html">CMpeg2Reader.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="CImageWriter_8h.html">CImageWriter.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="FieldVector_8h.html">FieldVector.h</a>&gt;</span>

<span class="keyword">using</span> <span class="keyword">namespace </span>std;

<span class="preprocessor">#define GETOPTARGS      "a:b:c:e:f:ghi:j:k:l:m:n:p:q:r:s:t:u:vw:x:y:z?C:F:IR:"</span>
<span class="preprocessor"></span><span class="preprocessor">#define max(a,b) (a&gt;b?a:b)</span>
<span class="preprocessor"></span>

<span class="keywordtype">bool</span> <a name="a0"></a><a class="code" href="CMotion2D_8cpp.html#a0">findChar</a>(string ch, <span class="keywordtype">char</span> *f)
{
  <span class="keywordtype">int</span> n = ch.find(f);
  <span class="keywordtype">int</span> size = ch.size();
  <span class="keywordflow">return</span> (n&gt;0 &amp;&amp; n&lt;size);
};


<span class="keywordtype">void</span> printresults(FILE *output, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i1, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i2,
                  <a name="_a1"></a><a class="code" href="classCMotion2DModel.html">CMotion2DModel</a> model, <span class="keywordtype">double</span> support_size,
                  <span class="keywordtype">unsigned</span> nbsubsample, <span class="keywordtype">double</span> multfactor);
<span class="keywordtype">int</span>  getoption (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv, <span class="keywordtype">char</span>* pszValidOpts, <span class="keywordtype">char</span>** ppszParam);
<span class="keywordtype">void</span> getoptions(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv,
                string &amp;ipath, <span class="keywordtype">unsigned</span> &amp;nbsubsample,
                <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> &amp;frame, <span class="keywordtype">int</span> &amp;step, <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> &amp;niter,
                string &amp;model_id, <span class="keywordtype">bool</span> &amp;var_light,
                <span class="keywordtype">bool</span> &amp;model_orig_fixed,
                <span class="keywordtype">double</span> &amp;model_row_orig, <span class="keywordtype">double</span> &amp;model_col_orig,
                <span class="keywordtype">unsigned</span> &amp;pyr_nlevels, <span class="keywordtype">unsigned</span> &amp;pyr_stop_level,
                <span class="keywordtype">bool</span> &amp;compute_covariance,
                string &amp;rpath, string &amp;bpath,
                <span class="keywordtype">int</span> &amp;b_nrows, <span class="keywordtype">int</span> &amp;b_ncols, <span class="keywordtype">int</span> &amp;b_row_orig, <span class="keywordtype">int</span> &amp;b_col_orig,
                string &amp;wpath, string &amp;spath, <span class="keywordtype">int</span> &amp;slabel,
                <span class="keywordtype">double</span> &amp;multfactor, <span class="keywordtype">bool</span> &amp;verbose,
                <span class="keywordtype">unsigned</span> &amp;raw_nrows, <span class="keywordtype">unsigned</span> &amp;raw_ncols, string &amp;Fpath,
                <span class="keywordtype">bool</span> &amp;useModelAsInitialization);

<span class="keywordtype">void</span> usage(<span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *badparam);


<span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Robust multiresolution estimation of parametric motion model.</span>
<span class="comment"></span>
<span class="comment">*/</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{
  <a name="_a2"></a><a class="code" href="classCMotion2DImage.html">CMotion2DImage&lt;short&gt;</a> I;              <span class="comment">// Image</span>
  <a class="code" href="classCMotion2DImage.html">CMotion2DImage&lt;unsigned char&gt;</a> S;      <span class="comment">// Motion estimator support</span>
  <a class="code" href="classCMotion2DImage.html">CMotion2DImage&lt;short&gt;</a> B;              <span class="comment">// Backwarped image</span>
  <a class="code" href="classCMotion2DImage.html">CMotion2DImage&lt;unsigned char&gt;</a> W;      <span class="comment">// M-estimator weights image</span>
  <a name="_a3"></a><a class="code" href="classCMotion2DEstimator.html">CMotion2DEstimator</a>    estimator;      <span class="comment">// Motion estimator</span>
  <a class="code" href="classCMotion2DModel.html">CMotion2DModel</a>        model;          <span class="comment">// Parametric motion model</span>
  <a name="_a4"></a><a class="code" href="classCMotion2DPyramid.html">CMotion2DPyramid</a>      pyramid1;       <span class="comment">// Pyramid on image 1</span>
  <a class="code" href="classCMotion2DPyramid.html">CMotion2DPyramid</a>      pyramid2;       <span class="comment">// Pyramid on image 2</span>
  <a name="_a5"></a><a class="code" href="classCMotion2DWarping.html">CMotion2DWarping</a>      warping;        <span class="comment">// Warping</span>

  <a name="_a6"></a><a class="code" href="classCReader.html">CReader</a>               *Ireader=NULL;  <span class="comment">// Image reader</span>
  <a class="code" href="classCReader.html">CReader</a>               *Sreader=NULL;  <span class="comment">// Support reader</span>
  <a name="_a7"></a><a class="code" href="classCMpeg2Reader.html">CMpeg2Reader</a>          mpegr;          <span class="comment">// Mpeg2 image decoder</span>
  <a name="_a8"></a><a class="code" href="classCImageReader.html">CImageReader</a>          imgr;           <span class="comment">// PNM or PNG image reader</span>
  <a name="_a9"></a><a class="code" href="classCWriter.html">CWriter</a>               *writer=NULL;   <span class="comment">// Image writer</span>
  <a name="_a10"></a><a class="code" href="classCImageWriter.html">CImageWriter</a>          imgw;           <span class="comment">// PNM or PNG image writer</span>


  string ipath(<span class="stringliteral">"../../test/sequence/rond-point%04d.pgm"</span>); <span class="comment">// Image path</span>
  string filename;              <span class="comment">// Complete filename for an image of the video</span>
  string rpath;                 <span class="comment">// Result filename to store the model</span>
  string bpath;                 <span class="comment">// Back-warped image path</span>
  string wpath;                 <span class="comment">// M-estimator weights image path</span>
  string spath;                 <span class="comment">// Estimation support path</span>
  string Fpath;                 <span class="comment">// Optic flow path</span>
  FILE   *rfile = NULL;         <span class="comment">// Result file to store the model</span>
  <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> niter = 33;     <span class="comment">// Number of images to process</span>
  <span class="keywordtype">int</span>  step = 1;                <span class="comment">// Step between 2 images</span>
  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> label = 234;    <span class="comment">// Value of the motion estimator support</span>
  <span class="keywordtype">int</span> slabel = -1;              <span class="comment">// Value of the motion estimator support</span>
  string model_id(<span class="stringliteral">"AC"</span>);        <span class="comment">// Parametric motion model ID to estimate</span>
  <span class="keywordtype">bool</span> var_light = <span class="keyword">false</span>;       <span class="comment">// Lighting variation parameter estimation</span>
  <span class="keywordtype">bool</span> model_orig_fixed = <span class="keyword">false</span>;<span class="comment">// Indicates if an origin is fixed</span>
  <span class="keywordtype">double</span> model_row_orig = -1.;  <span class="comment">// Motion model origin (line coordinate)</span>
  <span class="keywordtype">double</span> model_col_orig = -1.;  <span class="comment">// Motion model origin (column coordinate)</span>
  <span class="keywordtype">unsigned</span> pyr_nlevels = 4;     <span class="comment">// Number of levels in a multi-resolution pyr</span>
  <span class="keywordtype">unsigned</span> pyr_stop_level = 0;  <span class="comment">// Pyramid level where the estimator stops</span>
  <span class="keywordtype">bool</span> verbose = <span class="keyword">false</span>;         <span class="comment">// Verbose mode</span>
  <span class="keywordtype">bool</span> support_empty = <span class="keyword">false</span>;   <span class="comment">// Indicates if the support is empty.</span>

  <span class="keywordtype">int</span> b_ncols=-1, b_nrows=-1;   <span class="comment">// Back-warped image size</span>
  <span class="keywordtype">int</span> b_col_orig=0, b_row_orig=0;<span class="comment">// Back-warped origin in image frame</span>
  <span class="keywordtype">bool</span> compute_covariance = <span class="keyword">false</span>; <span class="comment">// Flag to compute the covariance matrix</span>
  <span class="keywordtype">unsigned</span> nbsubsample = 0;     <span class="comment">// Number of subsampling to apply</span>

  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> frame = 1;      <span class="comment">// First frame number to process</span>
  <span class="keywordtype">double</span> multfactor = 1.0;      <span class="comment">// Multiplier factor for motion parameters</span>
  <span class="keywordtype">unsigned</span> raw_nrows = 0;       <span class="comment">// Number of rows for RAW8 or RAW16 images</span>
  <span class="keywordtype">unsigned</span> raw_ncols = 0;       <span class="comment">// Number of cols for RAW8 or RAW16 images</span>
  <span class="keywordtype">bool</span> useModelAsInitialization = <span class="keyword">false</span>; <span class="comment">// How is the estimated model init</span>

  <span class="keywordtype">bool</span> ierr = <span class="keyword">true</span>;             <span class="comment">// Image IO return value</span>

  <span class="comment">// Read the program options</span>
  getoptions(argc, argv,
             ipath, nbsubsample, frame, step, niter,
             model_id, var_light,
             model_orig_fixed, model_row_orig, model_col_orig,
             pyr_nlevels, pyr_stop_level, compute_covariance,
             rpath,
             bpath, b_nrows, b_ncols, b_row_orig, b_col_orig,
             wpath, spath, slabel, multfactor, verbose, raw_nrows, raw_ncols,
             Fpath, useModelAsInitialization);

  <span class="comment">// Set the image reader format by regarding the image extension</span>
  <span class="keywordflow">if</span> (<a class="code" href="CMotion2D_8cpp.html#a0">findChar</a>(ipath, _mpg) || <a class="code" href="CMotion2D_8cpp.html#a0">findChar</a>(ipath, _mpeg))
    Ireader = &amp;mpegr;
  <span class="keywordflow">else</span>
    Ireader = &amp;imgr;

  Ireader-&gt;<a name="a11"></a><a class="code" href="classCReader.html#a2">setFileName</a>(ipath);
  Ireader-&gt;<a name="a12"></a><a class="code" href="classCReader.html#a4">setFrameNumber</a>(frame);
  filename = Ireader-&gt;<a name="a13"></a><a class="code" href="classCReader.html#a6">getFileName</a>();
  <a class="code" href="classCReader.html#s7">CReader::EReaderFormat</a> format = Ireader-&gt;<a name="a14"></a><a class="code" href="classCReader.html#a5">getFormat</a>();
  <span class="comment">// Test RAW format specific options</span>
  <span class="keywordflow">if</span> (format == <a class="code" href="classCReader.html#s7s3">CReader::FORMAT_RAW8</a> || format == <a class="code" href="classCReader.html#s7s4">CReader::FORMAT_RAW16</a>) {
    <span class="keywordflow">if</span> (raw_nrows == 0 || raw_ncols == 0) {
      cout &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"Error: When using option -p to specify RAW images path, "</span>
           &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"you have to specify the images size with option -R and -C."</span>
           &lt;&lt; endl;
      exit(0);
    }
  }

  <span class="keywordflow">if</span> (!Ireader-&gt;<a name="a15"></a><a class="code" href="classCReader.html#a9">openStream</a>()) {
    cout &lt;&lt;<span class="stringliteral">"Can't open video stream: "</span>&lt;&lt; ipath &lt;&lt;endl;
    exit(-1);
  }
  <span class="keywordflow">if</span> (verbose)
    cout &lt;&lt; <span class="stringliteral">"Load image: "</span> &lt;&lt; filename &lt;&lt; endl ;
  <span class="keywordflow">if</span> (Ireader-&gt;<a name="a16"></a><a class="code" href="classCReader.html#a7">getFrame</a>(I, nbsubsample, raw_nrows, raw_ncols) == <span class="keyword">false</span>) {
    cout &lt;&lt;<span class="stringliteral">" Error: Can't access to the frame..."</span> &lt;&lt; endl;
    exit(-1);
  }

<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>  <a class="code" href="classCMotion2DImage.html">CMotion2DImage&lt;short&gt;</a> T;
  T = I;
  cout &lt;&lt; <span class="stringliteral">"Apply median filter to image"</span> &lt;&lt; endl;
  T.<a name="a17"></a><a class="code" href="classCMotion2DImage.html#a11">MedianFilter</a>(5, 5);
  cout &lt;&lt; <span class="stringliteral">"Write median filter image"</span> &lt;&lt; endl;
  <a name="a18"></a><a class="code" href="Motion2DImage__PNM_8cpp.html#a5">WritePGM</a>(T, <span class="stringliteral">"/tmp/T.pgm"</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="comment">//cout &lt;&lt; "nbsubsample: " &lt;&lt; Ireader-&gt;getNbSubsample() &lt;&lt; endl;</span>

  <span class="comment">// Set the support reader format by regarding the image extension</span>
  <span class="keywordflow">if</span> (!spath.empty()) { <span class="comment">// Otherwise the support consist of the whole image</span>
    <span class="keywordflow">if</span> (<a class="code" href="CMotion2D_8cpp.html#a0">findChar</a>(spath, _mpg) || <a class="code" href="CMotion2D_8cpp.html#a0">findChar</a>(spath, _mpeg))
      Sreader = &amp;mpegr;
    <span class="keywordflow">else</span>
      Sreader = &amp;imgr;
    Sreader-&gt;<a class="code" href="classCReader.html#a2">setFileName</a>(spath);
    Sreader-&gt;<a class="code" href="classCReader.html#a4">setFrameNumber</a>(frame);
    <span class="keywordflow">if</span> (!Sreader-&gt;<a class="code" href="classCReader.html#a9">openStream</a>()) {
      cout &lt;&lt;<span class="stringliteral">"Can't open stream "</span>&lt;&lt; spath &lt;&lt;endl;
      exit(-1);
    }
  }

  <span class="comment">// Set the image writer</span>
  writer = &amp;imgw;

  <span class="comment">// Initialisation of the 2D parametric motion model to estimate</span>
  model.<a name="a19"></a><a class="code" href="classCMotion2DModel.html#a12">reset</a>();        <span class="comment">// Set all the parameters to zero</span>
  model.<a name="a20"></a><a class="code" href="classCMotion2DModel.html#a4">setIdModel</a>(model_id); <span class="comment">// Set the model id</span>
  model.<a name="a21"></a><a class="code" href="classCMotion2DModel.html#a6">setVarLight</a>(var_light); <span class="comment">// Set the illumination variation estimation</span>

  <span class="comment">// Initialize the model origin</span>
  <span class="keywordflow">if</span> ( ! model_orig_fixed) {
    <span class="comment">// Origin fixed at the middle of the image</span>
    model_row_orig = I.<a name="a22"></a><a class="code" href="classCMotion2DImage.html#a12">GetRows</a>() / 2.0;
    model_col_orig = I.<a name="a23"></a><a class="code" href="classCMotion2DImage.html#a13">GetCols</a>() / 2.0;
  }

  model.<a name="a24"></a><a class="code" href="classCMotion2DModel.html#a3">setOrigin</a>(model_row_orig, model_col_orig); <span class="comment">// Set the origin</span>

  <span class="comment">// Pyramids allocation for two successive images</span>
  pyramid1.<a name="a25"></a><a class="code" href="classCMotion2DPyramid.html#a3">allocate</a>(I.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>(), I.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>(), pyr_nlevels);
  pyramid2.<a class="code" href="classCMotion2DPyramid.html#a3">allocate</a>(I.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>(), I.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>(), pyr_nlevels);

  <span class="comment">// Fill the pyramid 1 whith image 1</span>
  pyramid1.<a name="a26"></a><a class="code" href="classCMotion2DPyramid.html#a4">build</a>(I.<a name="a27"></a><a class="code" href="classCMotion2DImage.html#m0">bitmap</a>);

  <span class="comment">// Initialize the motion estimator</span>
  <span class="comment">// Set the pyramid start estimation level</span>
  ierr = estimator.<a name="a28"></a><a class="code" href="classCMotion2DEstimator.html#a11">setFirstEstimationLevel</a>(pyr_nlevels - 1);
  <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
    exit(-1);
  }
  <span class="comment">// Set the pyramid stop estimation level</span>
  ierr = estimator.<a name="a29"></a><a class="code" href="classCMotion2DEstimator.html#a13">setLastEstimationLevel</a>(pyr_stop_level);
  <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
    exit(-1);
  }
  estimator.<a name="a30"></a><a class="code" href="classCMotion2DEstimator.html#a5">setRobustEstimator</a>(<span class="keyword">true</span>);

  <span class="keywordflow">if</span> (compute_covariance)
    estimator.<a name="a31"></a><a class="code" href="classCMotion2DEstimator.html#a22">computeCovarianceMatrix</a>(<span class="keyword">true</span>);

  <span class="comment">// Initialize the support</span>
  <span class="keywordflow">if</span> (spath.empty()) {
    <span class="comment">// Set the estimator support to the whole image</span>
    S.<a name="a32"></a><a class="code" href="classCMotion2DImage.html#a5">Init</a>(I.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>(), I.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>(), label);
  }
  <span class="keywordflow">else</span> {
    <span class="comment">// Set the support label value</span>
    label = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) slabel;
  }

  <span class="keywordflow">if</span> ( !bpath.empty() ) {
    <span class="comment">// Set the backwarped image size</span>
    <span class="comment">//B.Init(I.GetRows() +40, I.GetCols() +200 );</span>
    <span class="comment">// Init warping by positionning the reference image in the backwarped img.</span>
    <span class="comment">//warping.initBackWarp(B.GetRows(), B.GetCols(), -20, -20);</span>

    <span class="comment">// Set the backwarped image size</span>
    <span class="keywordflow">if</span> (b_nrows &lt;= 0) b_nrows = I.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>();
    <span class="keywordflow">if</span> (b_ncols &lt;= 0) b_ncols = I.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>();
    B.<a class="code" href="classCMotion2DImage.html#a5">Init</a>(b_nrows, b_ncols);
    warping.<a name="a33"></a><a class="code" href="classCMotion2DWarping.html#a2">initBackWarp</a>(B.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>(), B.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>(), b_row_orig, b_col_orig);

    <span class="comment">// Backwarp the first image, taken as image reference</span>
    warping.<a name="a34"></a><a class="code" href="classCMotion2DWarping.html#a3">backWarp</a>(I.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>, I.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>(), I.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>(), B.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>, model);

    <span class="comment">// Construct the backwarped image filename</span>
    writer-&gt;<a name="a35"></a><a class="code" href="classCWriter.html#a2">setFileName</a>(bpath);
    writer-&gt;<a name="a36"></a><a class="code" href="classCWriter.html#a4">setFrameNumber</a>(frame);
    filename = writer-&gt;<a name="a37"></a><a class="code" href="classCWriter.html#a6">getFileName</a>();
    <span class="keywordflow">if</span> (verbose)
      cout &lt;&lt; <span class="stringliteral">"\tWrite backwarped image: "</span> &lt;&lt; filename &lt;&lt; endl ;
    ierr = writer-&gt;<a name="a38"></a><a class="code" href="classCWriter.html#a7">writeFrame</a>(B);      <span class="comment">// Write the backwarped image</span>
    <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
      cout &lt;&lt; <span class="stringliteral">"Can not write the image: "</span> &lt;&lt; filename &lt;&lt; endl;
      exit(-1);
    }
  }

  <span class="comment">// Open the result file</span>
  <span class="keywordflow">if</span> ( !rpath.empty() ) {
    rfile = fopen(rpath.c_str(), <span class="stringliteral">"wb"</span>);
    string s = model.<a name="a39"></a><a class="code" href="classCMotion2DModel.html#a14">idToString</a>();

    fprintf(rfile, <span class="stringliteral">"# Motion2D-1.3.11 Copyright (c) 1995-2005 by INRIA\n\</span>
<span class="stringliteral"># \n\</span>
<span class="stringliteral"># This file contains the parameter values of the estimated 2D \n\</span>
<span class="stringliteral"># parametric motion model. A comment line starts with the # \n\</span>
<span class="stringliteral"># character. After the comments, the first line refers to the \n\</span>
<span class="stringliteral"># estimated model id. The next line to a multiplier factor \n\</span>
<span class="stringliteral"># applied to all the motion model parameters (c1,c2,a1...a4,q1..q6)\n\</span>
<span class="stringliteral"># to increase their resolution. Next, each line refers to the \n\</span>
<span class="stringliteral"># motion model estimated between two successive images. \n\</span>
<span class="stringliteral"># \n\</span>
<span class="stringliteral"># The data signification is given below. \n\</span>
<span class="stringliteral"># \n\</span>
<span class="stringliteral"># |--------------------------------------------------------| \n\</span>
<span class="stringliteral"># | column | data signification for each estimation        | \n\</span>
<span class="stringliteral"># | number | between two successive images.                | \n\</span>
<span class="stringliteral"># |--------|-----------------------------------------------| \n\</span>
<span class="stringliteral"># |   1    | number of the first image                     | \n\</span>
<span class="stringliteral"># |--------|-----------------------------------------------| \n\</span>
<span class="stringliteral"># |   2    | motion model origin (row coordinate or yc)    | \n\</span>
<span class="stringliteral"># |   3    | motion model origin (column coordinate or xc) | \n\</span>
<span class="stringliteral"># |--------|-----------------------------------------------| \n\</span>
<span class="stringliteral"># |   4    | motion model parameter (c1)                   | \n\</span>
<span class="stringliteral"># |   5    | motion model parameter (c2)                   | \n\</span>
<span class="stringliteral"># |--------|-----------------------------------------------| \n\</span>
<span class="stringliteral"># |   6    | motion model parameter (a1)                   | \n\</span>
<span class="stringliteral"># |   7    | motion model parameter (a2)                   | \n\</span>
<span class="stringliteral"># |   8    | motion model parameter (a3)                   | \n\</span>
<span class="stringliteral"># |   9    | motion model parameter (a4)                   | \n\</span>
<span class="stringliteral"># |--------|-----------------------------------------------| \n"</span>);

fprintf(rfile, <span class="stringliteral">"\</span>
<span class="stringliteral"># |  10    | motion model parameter (q1)                   | \n\</span>
<span class="stringliteral"># |  11    | motion model parameter (q2)                   | \n\</span>
<span class="stringliteral"># |  12    | motion model parameter (q3)                   | \n\</span>
<span class="stringliteral"># |  13    | motion model parameter (q4)                   | \n\</span>
<span class="stringliteral"># |  14    | motion model parameter (q5)                   | \n\</span>
<span class="stringliteral"># |  15    | motion model parameter (q6)                   | \n\</span>
<span class="stringliteral"># |--------|-----------------------------------------------| \n\</span>
<span class="stringliteral"># |  16    | illumination variation parameter              | \n\</span>
<span class="stringliteral"># |--------|-----------------------------------------------| \n\</span>
<span class="stringliteral"># |  17    | support size (only if computed, by default)   | \n\</span>
<span class="stringliteral"># |--------|-----------------------------------------------| \n\</span>
<span class="stringliteral">#  \n\</span>
<span class="stringliteral">MODEL_ID = %s\n\</span>
<span class="stringliteral">MULTIPLIER_FACTOR = %lf\n"</span>, s.c_str(), multfactor);
  }
  <span class="comment">// Robust estimation loop</span>
  <span class="keywordflow">for</span> (<span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> n=1; n &lt;= niter; n++) {

    <span class="comment">// Initialize the support</span>
    <span class="keywordflow">if</span> (!spath.empty()) { <span class="comment">// Otherwise the support consist of the whole image</span>

      Sreader-&gt;<a class="code" href="classCReader.html#a2">setFileName</a>(spath);
      Sreader-&gt;<a class="code" href="classCReader.html#a4">setFrameNumber</a>(frame);
      filename = Sreader-&gt;<a class="code" href="classCReader.html#a6">getFileName</a>();
      <span class="keywordflow">if</span> (verbose)
        cout &lt;&lt; <span class="stringliteral">"Load support: "</span> &lt;&lt; filename &lt;&lt; endl;
      ierr = Sreader-&gt;<a class="code" href="classCReader.html#a7">getFrame</a>(S, nbsubsample, raw_nrows, raw_ncols);
      <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
        cout &lt;&lt; <span class="stringliteral">"Can not read the support image: "</span> &lt;&lt; filename &lt;&lt; endl;
        exit(-1);
      }

      <span class="comment">// Test if the support is empty</span>
      support_empty = <span class="keyword">true</span>;
      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i &lt; S.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>() * S.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>(); i++) {
        <span class="keywordflow">if</span> (S.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>[i] == label) {
          support_empty = <span class="keyword">false</span>;
          <span class="keywordflow">break</span>;
        }
      }

      <span class="keywordflow">if</span> (support_empty) {
        <span class="keywordflow">if</span> (verbose)
          cout &lt;&lt; <span class="stringliteral">"\tWarning: the support is empty, motion estimation not done"</span>
               &lt;&lt; endl;
      }
    }

    <span class="comment">// Update the image frame number</span>
    frame += step;

    <span class="comment">// Load the next image (image 2)</span>
    Ireader-&gt;<a class="code" href="classCReader.html#a2">setFileName</a>(ipath);
    Ireader-&gt;<a class="code" href="classCReader.html#a4">setFrameNumber</a>(frame);
    filename = Ireader-&gt;<a class="code" href="classCReader.html#a6">getFileName</a>();
    <span class="keywordflow">if</span> (verbose)
      cout &lt;&lt; <span class="stringliteral">"Load image: "</span> &lt;&lt; filename &lt;&lt; endl ;
    ierr = Ireader-&gt;<a class="code" href="classCReader.html#a7">getFrame</a>(I, nbsubsample, raw_nrows, raw_ncols);
    <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
      cout &lt;&lt; <span class="stringliteral">"Can not read the image: "</span> &lt;&lt; filename &lt;&lt; endl;
      exit(-1);
    }

    <span class="comment">// Fill the pyramid 2 with image 2</span>
    pyramid2.<a class="code" href="classCMotion2DPyramid.html#a4">build</a>(I.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>);

    <span class="comment">// 2D Parametric motion estimation</span>
    <span class="keywordflow">if</span> ( ! support_empty) {
      <span class="keywordtype">bool</span> state;
      <span class="comment">//#define INIT_ESTIMATOR_WITH_MODEL</span>
<span class="preprocessor">#ifdef INIT_ESTIMATOR_WITH_MODEL</span>
<span class="preprocessor"></span>      <span class="keywordtype">double</span> parameters[<a class="code" href="classCMotion2DModel.html#s1s0">CMotion2DModel::MDL_NMAX_COEF</a>];

      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="classCMotion2DModel.html#s1s0">CMotion2DModel::MDL_NMAX_COEF</a>; i ++)
        parameters[i] = 0.0;
<span class="comment">//       parameters[0] = -4.958804;</span>
<span class="comment">//       parameters[1] = -0.243949;</span>
<span class="comment">//       parameters[2] = 0.002562;</span>
<span class="comment">//       parameters[3] = -0.023941;</span>
<span class="comment">//       parameters[4] = 0.002625;</span>
<span class="comment">//       parameters[5] = 0.008823;</span>
      parameters[0] = 30.;
      parameters[1] = -23;
      model.<a name="a40"></a><a class="code" href="classCMotion2DModel.html#a7">setParameters</a>(parameters);
      state = estimator.<a name="a41"></a><a class="code" href="classCMotion2DEstimator.html#a2">estimate</a>(pyramid1, pyramid2, S.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>, label, model,
                                 useModelAsInitialization);

<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      state = estimator.<a class="code" href="classCMotion2DEstimator.html#a2">estimate</a>(pyramid1, pyramid2, S.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>,
                                 label, model, useModelAsInitialization);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
      <span class="keywordflow">if</span> (state == <span class="keyword">false</span>){
        <span class="comment">//pyramid1.destroy();</span>
        <span class="comment">//pyramid2.destroy();</span>
        <span class="comment">//exit(0);</span>
        cout &lt;&lt; <span class="stringliteral">"\nError during motion estimation. "</span> &lt;&lt; endl
             &lt;&lt; <span class="stringliteral">"Possible reason: not enought gradient."</span> &lt;&lt; endl
             &lt;&lt; <span class="stringliteral">"The model is set to zero..."</span> &lt;&lt; endl &lt;&lt; endl;
      }
    }

    <span class="comment">// Exchange pyramid 1 and 2</span>
    pyramid1.<a name="a42"></a><a class="code" href="classCMotion2DPyramid.html#a15">exchange</a>(pyramid2);

    <span class="keywordflow">if</span> (support_empty) {
      <span class="keywordflow">continue</span>;
    }

<span class="comment">//     {</span>
<span class="comment">//       CMotion2DModel newmodel;</span>
<span class="comment">//       int deltalevel = 2;</span>

<span class="comment">//       newmodel = model.getModelLevel(deltalevel);</span>
<span class="comment">//       cout &lt;&lt; "debug" &lt;&lt; endl;</span>
<span class="comment">//       printresults(stdout, frame - step, frame, newmodel, 0.0, nbsubsample);</span>
<span class="comment">//       cout &lt;&lt; "end debug" &lt;&lt; endl;</span>

<span class="comment">//     }</span>

    <span class="comment">// Print results</span>
    <span class="keywordtype">double</span> support_size;
    <span class="keywordflow">if</span> (! estimator.<a name="a43"></a><a class="code" href="classCMotion2DEstimator.html#a18">getSupportSize</a>(support_size)) support_size = -1.;
    <span class="keywordflow">if</span> (verbose) {
      printresults(stdout, frame - step, frame, model,
                   support_size, nbsubsample, multfactor);
      <span class="keywordflow">if</span> ( estimator.<a name="a44"></a><a class="code" href="classCMotion2DEstimator.html#a20">isResidualVarianceComputed</a>() )
        cout &lt;&lt; <span class="stringliteral">"\tResidual variance: "</span>
             &lt;&lt; estimator.<a name="a45"></a><a class="code" href="classCMotion2DEstimator.html#a21">getResidualVariance</a>() &lt;&lt; endl;

      <span class="keywordflow">if</span> ( estimator.<a name="a46"></a><a class="code" href="classCMotion2DEstimator.html#a23">isCovarianceMatrixComputed</a>() ) {
        <span class="keywordtype">int</span> cov_nrows, cov_ncols;
        <span class="keywordtype">double</span> *cov = estimator.<a name="a47"></a><a class="code" href="classCMotion2DEstimator.html#a24">getCovarianceMatrix</a>(cov_nrows, cov_ncols);
        cout &lt;&lt; <span class="stringliteral">"\tCovariance matrix: "</span> &lt;&lt;  endl;
        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; cov_nrows; i ++) {
          cout &lt;&lt; <span class="stringliteral">"\t"</span>;
          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt; cov_ncols; j ++) {
            fprintf(stdout, <span class="stringliteral">"%9.3g "</span>, cov[i*cov_ncols + j]);
            <span class="comment">//cout &lt;&lt; cov[i*cov_ncols + j] &lt;&lt; " ";</span>
          }
          cout &lt;&lt; endl;
        }
      }
    }

    <span class="keywordflow">if</span> ( !rpath.empty() ) {
      <span class="keywordflow">if</span> (verbose)
        cout &lt;&lt; <span class="stringliteral">"\tUpdate the result file: "</span> &lt;&lt; rpath
             &lt;&lt; <span class="stringliteral">" frames "</span> &lt;&lt; frame-step &lt;&lt; <span class="stringliteral">", "</span>&lt;&lt;frame&lt;&lt; endl;
      printresults(rfile, frame - step, frame, model,
                   support_size, nbsubsample, multfactor);
    }

    <span class="keywordflow">if</span> ( !bpath.empty() ) {
      <span class="comment">// Backwarp the current image in the first image reference frame</span>
      warping.<a class="code" href="classCMotion2DWarping.html#a3">backWarp</a>(I.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>, I.<a class="code" href="classCMotion2DImage.html#a12">GetRows</a>(), I.<a class="code" href="classCMotion2DImage.html#a13">GetCols</a>(), B.<a class="code" href="classCMotion2DImage.html#m0">bitmap</a>, model);

      <span class="comment">// Construct the backwarped image filename</span>

      writer-&gt;<a class="code" href="classCWriter.html#a2">setFileName</a>(bpath);
      writer-&gt;<a class="code" href="classCWriter.html#a4">setFrameNumber</a>(frame);
      filename = writer-&gt;<a class="code" href="classCWriter.html#a6">getFileName</a>();
      <span class="keywordflow">if</span> (verbose)
        cout &lt;&lt; <span class="stringliteral">"\tWrite backwarped image: "</span> &lt;&lt; filename &lt;&lt; endl ;
      ierr = writer-&gt;<a class="code" href="classCWriter.html#a7">writeFrame</a>(B);    <span class="comment">// Write the backwarped image</span>
      <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
        cout &lt;&lt; <span class="stringliteral">"Can not write the backwarped image: "</span> &lt;&lt; filename &lt;&lt; endl;
        exit(-1);
      }
    }

    <span class="keywordflow">if</span> ( !wpath.empty() ) {
      <span class="keywordtype">float</span> *weights = NULL;
      <span class="keywordtype">int</span> n_rows = 0, n_cols = 0;
      weights = estimator.<a name="a48"></a><a class="code" href="classCMotion2DEstimator.html#a4">getWeights</a>(n_rows, n_cols); <span class="comment">// weights are in [0,1]</span>
      W.<a class="code" href="classCMotion2DImage.html#a5">Init</a>(n_rows, n_cols);
      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; n_rows; i++)
        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt; n_cols; j++)
          W[i][j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) (weights[i*n_cols + j] * 255);

      <span class="comment">// Construct the M-estimator weights image filename</span>
      writer-&gt;<a class="code" href="classCWriter.html#a2">setFileName</a>(wpath);
      writer-&gt;<a class="code" href="classCWriter.html#a4">setFrameNumber</a>(frame - step);
      filename = writer-&gt;<a class="code" href="classCWriter.html#a6">getFileName</a>();
      <span class="keywordflow">if</span> (verbose)
        cout &lt;&lt; <span class="stringliteral">"\tWrite M-estimator weights image: "</span> &lt;&lt; filename &lt;&lt; endl;
      ierr = writer-&gt;<a class="code" href="classCWriter.html#a7">writeFrame</a>(W);
      <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
        cout &lt;&lt; <span class="stringliteral">"Can not write the weights image: "</span> &lt;&lt; filename &lt;&lt; endl;
        exit(-1);
      }
    }

    <span class="keywordflow">if</span> ( !Fpath.empty() ) {
      <span class="comment">// Construct the field vector image filename</span>
      writer-&gt;<a class="code" href="classCWriter.html#a2">setFileName</a>(Fpath);
      writer-&gt;<a class="code" href="classCWriter.html#a4">setFrameNumber</a>(frame - step);
      filename = writer-&gt;<a class="code" href="classCWriter.html#a6">getFileName</a>();
      <span class="keywordflow">if</span> (verbose)
        cout &lt;&lt; <span class="stringliteral">"\tWrite field vector image: "</span> &lt;&lt; filename &lt;&lt; endl ;

      <span class="comment">// Compute and save the displacement vector in all pixels</span>
      ierr = <a name="a49"></a><a class="code" href="FieldVector_8cpp.html#a0">WriteFieldVector</a>(model, S, label, filename.c_str());
      <span class="keywordflow">if</span> (ierr == <span class="keyword">false</span>) {
        cout &lt;&lt; <span class="stringliteral">"Can not write the field vector image: "</span> &lt;&lt; filename &lt;&lt; endl;
        exit(-1);
      }
    }
  }

  <span class="comment">// Destruction des pyramides</span>
  pyramid1.<a name="a50"></a><a class="code" href="classCMotion2DPyramid.html#a8">destroy</a>();
  pyramid2.<a class="code" href="classCMotion2DPyramid.html#a8">destroy</a>();

  <span class="keywordflow">if</span> ( !rpath.empty() )
    fclose(rfile);

  Ireader-&gt;<a name="a51"></a><a class="code" href="classCReader.html#a10">closeStream</a>();
  <span class="keywordflow">if</span> (!spath.empty()) {
    Sreader-&gt;<a class="code" href="classCReader.html#a10">closeStream</a>();
  }

  <span class="keywordflow">return</span> 0;
}


<span class="comment">/*</span>
<span class="comment">  Print results.</span>
<span class="comment"></span>
<span class="comment">*/</span>
<span class="keywordtype">void</span> printresults(FILE *output, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i1, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i2,
                  <a class="code" href="classCMotion2DModel.html">CMotion2DModel</a> model, <span class="keywordtype">double</span> support_size,
                  <span class="keywordtype">unsigned</span> nbsubsample, <span class="keywordtype">double</span> multfactor)
{
  <span class="keywordtype">double</span> row, col;
  <span class="keywordtype">double</span> parameters[<a class="code" href="classCMotion2DModel.html#s1s0">CMotion2DModel::MDL_NMAX_COEF</a>];
  <span class="keywordtype">double</span> var_light;

  <a class="code" href="classCMotion2DModel.html">CMotion2DModel</a> _model;
  <span class="comment">// Transform the model at the highest image resolution</span>
  _model = model.<a name="a52"></a><a class="code" href="classCMotion2DModel.html#a20">getModelLevel</a>(-nbsubsample);
  _model.<a name="a53"></a><a class="code" href="classCMotion2DModel.html#a21">getOrigin</a>(row, col);
  _model.<a name="a54"></a><a class="code" href="classCMotion2DModel.html#a11">getParameters</a>(parameters);

  <span class="keywordflow">if</span> (output == stdout) {
    <span class="comment">// Print the motion estimation results</span>
    fprintf(output, <span class="stringliteral">"\t2D estimated model between images %lu and %lu:\n\t"</span>,
            i1, i2);

    fprintf(output, <span class="stringliteral">"origin: %f %f\n\t"</span>, row, col);

    string s = _model.<a class="code" href="classCMotion2DModel.html#a14">idToString</a>();
    fprintf(output, <span class="stringliteral">"motion model: %s\n"</span>, s.c_str());
    fprintf(output, <span class="stringliteral">"\tx: %f | %f %f | %f %f %f \n"</span>,
            parameters[0], parameters[2], parameters[3],
            parameters[6], parameters[7], parameters[8]);
    fprintf(output, <span class="stringliteral">"\ty: %f | %f %f | %f %f %f \n"</span>,
            parameters[1], parameters[4], parameters[5],
            parameters[9], parameters[10], parameters[11]);

    <span class="keywordflow">if</span> (_model.<a name="a55"></a><a class="code" href="classCMotion2DModel.html#a18">getVarLight</a>(var_light))
      fprintf(output, <span class="stringliteral">"\tglobal illumination: %f \n"</span>, var_light);

    <span class="keywordflow">if</span> (support_size != -1.)
      fprintf(output, <span class="stringliteral">"\tsupport size: %f \n"</span>, support_size);
  }
  <span class="keywordflow">else</span> {
    fprintf(output, <span class="stringliteral">"%lu %f %f "</span>, i1, row, col);
    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classCMotion2DModel.html#s1s0">CMotion2DModel::MDL_NMAX_COEF</a>; i++)
      fprintf(output, <span class="stringliteral">"%f "</span>, parameters[i] * multfactor);
    <span class="keywordflow">if</span> (!_model.<a class="code" href="classCMotion2DModel.html#a18">getVarLight</a>(var_light)) var_light = 0;
      fprintf(output, <span class="stringliteral">"%f "</span>, var_light);
    <span class="keywordflow">if</span> (support_size != -1.)
      fprintf(output, <span class="stringliteral">"%f "</span>, support_size);
    fprintf(output, <span class="stringliteral">"\n"</span>);
  }
  fflush(output);
}



<span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Print the program options.</span>
<span class="comment"></span>
<span class="comment"> */</span>
<span class="keywordtype">void</span> usage(<span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *badparam)
{
  <span class="keywordflow">if</span> (badparam)
    fprintf(stderr, <span class="stringliteral">"\nBad parameter [%s]\n"</span>, badparam);

  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  Copyright (c) 1995-2005 by INRIA.\n\</span>
<span class="stringliteral">  All Rights Reserved.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  This software was developed at:\n\</span>
<span class="stringliteral">  IRISA/INRIA Rennes\n\</span>
<span class="stringliteral">  Campus Universitaire de Beaulieu \n\</span>
<span class="stringliteral">  35042 Rennes Cedex\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  http://www.irisa.fr\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">SYNOPSIS\n\</span>
<span class="stringliteral">  %s [-p image or video path] [-R rows number for RAW images]\n\</span>
<span class="stringliteral">  [-C columns number for RAW images] [-f first frame]\n\</span>
<span class="stringliteral">  [-s step] [-i iterations] [-m model id] [-g] [-x model col orig]\n\</span>
<span class="stringliteral">  [-y model row orig] [-a support image or video path] [-z] \n\</span>
<span class="stringliteral">  [-c support label] [-q nbsubsample] [-n number of pyramid levels] \n\</span>
<span class="stringliteral">  [-l pyramid stop level] [-r dominant motion filename] \n\</span>
<span class="stringliteral">  [-r multiplier factor] [-b back warped image path] \n\</span>
<span class="stringliteral">  [-j back warped image nrows] [-k back warped image ncols] \n\</span>
<span class="stringliteral">  [-t back warped image row origin] [-u back warped image col origin] \n\</span>
<span class="stringliteral">  [-w weights image path] [-F optic flow field] [-I] [-v] [-h] [-?]\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">DESCRIPTION\n\</span>
<span class="stringliteral">  The Motion2D software provides a method to estimate 2D parametric\n\</span>
<span class="stringliteral">  motion models between two successive images. It can handle several\n\</span>
<span class="stringliteral">  types of motion models, respectively, constant model (translation),\n\</span>
<span class="stringliteral">  affine, and quadratic models. Moreover, it integrates the possibi-\n\</span>
<span class="stringliteral">  lity of taking into account the global variation of illumination.\n\</span>
<span class="stringliteral">  Motivations for the use of such models are, on one hand, their\n\</span>
<span class="stringliteral">  efficiency, which has been demonstrated in numerous contexts such\n\</span>
<span class="stringliteral">  as estimation, segmentation, tracking, and interpretation of motion, \n\</span>
<span class="stringliteral">  and on the other hand, their low conputational cost compared to \n\</span>
<span class="stringliteral">  optical flow estimation. Moreover to have the best accuracy for the\n\</span>
<span class="stringliteral">  estimated parameters, and to take into account the problem of mul-\n\</span>
<span class="stringliteral">  tiple motion, Motion2D exploit a robust, multiresolution and incre-\n\</span>
<span class="stringliteral">  mental estimation method exploiting only the spatio-temporal deri-\n\</span>
<span class="stringliteral">  vatives of the intensity function.\n"</span>, name);

<span class="preprocessor">#ifndef __NO_IMAGEIO_PNG_</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  Motion2D can handle Mpeg2, PNG, PNM and RAW image file formats. \n\</span>
<span class="stringliteral">  The different PNM formats are PGM (P5) and PPM (P6). A RAW image \n\</span>
<span class="stringliteral">  file contains simply the list of pixel values with no header. \n\</span>
<span class="stringliteral">  Two sets of RAW format are supported, one for the traditional \n\</span>
<span class="stringliteral">  8-bits images nammed RAW8, the other for 9 to 16 bits images \n\</span>
<span class="stringliteral">  named RAW16.\n"</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  Motion2D can handle Mpeg2, PNM and RAW image file formats. \n\</span>
<span class="stringliteral">  The different PNM formats are PGM (P5) and PPM (P6). A RAW image \n\</span>
<span class="stringliteral">  file contains simply the list of pixel values with no header. \n\</span>
<span class="stringliteral">  Two sets of RAW format are supported, one for the traditional \n\</span>
<span class="stringliteral">  8-bits images nammed RAW8, the other for 9 to 16 bits images \n\</span>
<span class="stringliteral">  named RAW16.\n"</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#ifndef __NO_IMAGEIO_PNG_</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">INPUT SEQUENCE OPTIONS:                                       Default\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -p [%%s]: image or video path \n\</span>
<span class="stringliteral">     . Dealing with an image sequence:                                 \n\</span>
<span class="stringliteral">         By image sequence, we mean one file per image.\n\</span>
<span class="stringliteral">         Specify the path and the generic name of the files \n\</span>
<span class="stringliteral">         containing the images to process. The following image \n\</span>
<span class="stringliteral">         file formats PNG, PNM (PGM P5, PPM P6) and RAW \n\</span>
<span class="stringliteral">         (RAW8, RAW16) are supported. The format is selected by \n\</span>
<span class="stringliteral">         analysing the filename extension.\n\</span>
<span class="stringliteral">         Example: -p rond-point%%04d.png\n\</span>
<span class="stringliteral">     . Dealing with a video:                                 \n\</span>
<span class="stringliteral">         By video, we mean one file for all images of the video.\n\</span>
<span class="stringliteral">         Specify the video file. Only Mpeg2 file are supported. \n\</span>
<span class="stringliteral">         Warning: in a Mpeg2 video stream the first frame  \n\</span>
<span class="stringliteral">         has the number zero. \n\</span>
<span class="stringliteral">         Example: -p video.mpg -f 0 \n"</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">INPUT SEQUENCE OPTIONS:                                       Default\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -p [%%s]: image or video path \n\</span>
<span class="stringliteral">     . Dealing with an image sequence:                                 \n\</span>
<span class="stringliteral">         By image sequence, we mean one file per image.\n\</span>
<span class="stringliteral">         Specify the path and the generic name of the files \n\</span>
<span class="stringliteral">         containing the images to process. The following image \n\</span>
<span class="stringliteral">         file formats PNM (PGM P5, PPM P6) and RAW (RAW8, RAW16)\n\</span>
<span class="stringliteral">         are supported. The format is selected by analysing the \n\</span>
<span class="stringliteral">         filename extension.\n\</span>
<span class="stringliteral">         Example: -p rond-point%%04d.pgm\n\</span>
<span class="stringliteral">     . Dealing with a video:                                 \n\</span>
<span class="stringliteral">         By video, we mean one file for all images of the video.\n\</span>
<span class="stringliteral">         Specify the video file. Only Mpeg2 file are supported. \n\</span>
<span class="stringliteral">         Warning: in a Mpeg2 video stream the first frame  \n\</span>
<span class="stringliteral">         has the number zero. \n\</span>
<span class="stringliteral">         Example: -p video.mpg -f 0\n"</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -R [%%d]: Number of rows in RAW image.            \n\</span>
<span class="stringliteral">     Specify the number of rows for RAW sequences.          \n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -C [%%d]: Number of columns in RAW image.               \n\</span>
<span class="stringliteral">     Specify the number of columns for RAW sequences.          \n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -f [%%s]: first frame                                             1\n\</span>
<span class="stringliteral">     Specify the number of the first frame in the video \n\</span>
<span class="stringliteral">     sequence. If the image sequence numbering uses a fixed \n\</span>
<span class="stringliteral">     number of digits, complete whith 0 before the image \n\</span>
<span class="stringliteral">     number.\n\</span>
<span class="stringliteral">     Warning: the first frame of a Mpeg2 video stream has the\n\</span>
<span class="stringliteral">     number zero.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -s [%%d]: step                                                    1\n\</span>
<span class="stringliteral">     Specify the step between two frames in the video sequence.\n\</span>
<span class="stringliteral">     If step &gt; 0 images are processed forward. If step &lt; 0 \n\</span>
<span class="stringliteral">     images are processed backward. This parameter allow the \n\</span>
<span class="stringliteral">     video temporal subsampling.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -i [%%lu]: iterations                                            33\n\</span>
<span class="stringliteral">     Specify the number of motion estimation iterations to\n\</span>
<span class="stringliteral">     process. The number of the last image computed is given by:\n\</span>
<span class="stringliteral">     first_frame + iterations * step.\n\</span>
<span class="stringliteral">\n"</span>);

  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">MOTION MODEL OPTIONS (input):\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -m [%%s]: model id                                               AC\n\</span>
<span class="stringliteral">     Specify the parametric motion model id to estimate. The\n\</span>
<span class="stringliteral">     table below gives the list of possible model_id strings: \n\</span>
<span class="stringliteral">     |-----------------------------------------------------| \n\</span>
<span class="stringliteral">     | model_id | type        | number of parameters       | \n\</span>
<span class="stringliteral">     |-----------------------------------------------------| \n\</span>
<span class="stringliteral">     | TX       | constant    |  1 (c1)                    | \n\</span>
<span class="stringliteral">     | TY       | constant    |  1 (c2)                    | \n\</span>
<span class="stringliteral">     | TR       | constant    |  2 (c1,c2)                 | \n\</span>
<span class="stringliteral">     | ----------------------------------------------------| \n\</span>
<span class="stringliteral">     | AXD      | affine      |  2 (c1,a1)                 | \n\</span>
<span class="stringliteral">     | ARD      | affine      |  3 (c1,c2,a1)              | \n\</span>
<span class="stringliteral">     | ARR      | affine      |  3 (c1,c2,a1)              | \n\</span>
<span class="stringliteral">     | AXN      | affine      |  5 (c2,a1...a4)            | \n\</span>
<span class="stringliteral">     | AYN      | affine      |  5 (c1,a1...a4)            | \n\</span>
<span class="stringliteral">     | ADN      | affine      |  5 (c1,c2,a1,a2,a3)        | \n\</span>
<span class="stringliteral">     | ARN      | affine      |  5 (c1,c2,a1,a2,a4)        | \n\</span>
<span class="stringliteral">     | AH1N     | affine      |  5 (c1,c2,a1,a2,a3)        | \n\</span>
<span class="stringliteral">     | AH2N     | affine      |  5 (c1,c2,a1,a2,a4)        | \n\</span>
<span class="stringliteral">     | ARRD     | affine      |  4 (c1,c2,a1,a2)           | \n\</span>
<span class="stringliteral">     | AC       | affine      |  6 (c1,c2,a1...a4)         | \n\</span>
<span class="stringliteral">     | ----------------------------------------------------| \n\</span>
<span class="stringliteral">     | QPD      | quadratic   |  4 (c1,a1,q1,q2)           | \n\</span>
<span class="stringliteral">     | QPT      | quadratic   |  4 (c1,c2,q1,q2)           | \n\</span>
<span class="stringliteral">     | QPTD     | quadratic   |  5 (c1,c2,a1,q1,q2)        | \n\</span>
<span class="stringliteral">     | Q2D      | quadratic   |  8 (c1,c2,a1...a4,q1,q2)   | \n\</span>
<span class="stringliteral">     | QC       | quadratic   | 12 (c1,c2,a1...a4,q1...q6) | \n\</span>
<span class="stringliteral">     ------------------------------------------------------| \n"</span>);
  fprintf(stdout, <span class="stringliteral">"\</span>
<span class="stringliteral">     | MDL_TX               | same as TX                   | \n\</span>
<span class="stringliteral">     | MDL_TY               | same as TX                   | \n\</span>
<span class="stringliteral">     | MDL_TR               | same as TR                   | \n\</span>
<span class="stringliteral">     | MDL_AFF_TX_DIV       | same as AXD                  | \n\</span>
<span class="stringliteral">     | MDL_AFF_TR_DIV       | same as ARD                  | \n\</span>
<span class="stringliteral">     | MDL_AFF_TR_ROT       | same as ARR                  | \n\</span>
<span class="stringliteral">     | MDL_AFF_TX_NULL      | same as AXN                  | \n\</span>
<span class="stringliteral">     | MDL_AFF_TY_NULL      | same as AYN                  | \n\</span>
<span class="stringliteral">     | MDL_AFF_DIV_NULL     | same as ADN                  | \n\</span>
<span class="stringliteral">     | MDL_AFF_ROT_NULL     | same as ARN                  | \n\</span>
<span class="stringliteral">     | MDL_AFF_HYP1_NULL    | same as AH1N                 | \n\</span>
<span class="stringliteral">     | MDL_AFF_HYP2_NULL    | same as AH2N                 | \n\</span>
<span class="stringliteral">     | MDL_AFF_TR_ROT_DIV   | same as ARRD                 | \n\</span>
<span class="stringliteral">     | MDL_AFF_COMPLET      | same as AC                   | \n\</span>
<span class="stringliteral">     | MDL_QUA_PAN_DIV      | same as QPD                  | \n\</span>
<span class="stringliteral">     | MDL_QUA_PAN_TILT     | same as QPT                  | \n\</span>
<span class="stringliteral">     | MDL_QUA_PAN_TILT_DIV | same as QPTD                 | \n\</span>
<span class="stringliteral">     | MDL_QUA_2D           | same as Q2D                  | \n\</span>
<span class="stringliteral">     | MDL_QUA_COMPLET      | same as QC                   | \n\</span>
<span class="stringliteral">     ------------------------------------------------------| \n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -g\n\</span>
<span class="stringliteral">     Specify that the global illumination parameter will be\n\</span>
<span class="stringliteral">     estimated.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -I\n\</span>
<span class="stringliteral">     Uses the previous estimation to initialize the motion model \n\</span>
<span class="stringliteral">     to estimate.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -x [%%f]: model col orig \n\</span>
<span class="stringliteral">     Sets the origin (column coordinate) of the motion model.\n\</span>
<span class="stringliteral">     By default, this parameter is initialized to the mid image\n\</span>
<span class="stringliteral">     column number.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -y [%%f]: model row orig \n\</span>
<span class="stringliteral">     Sets the origin (row coordinate) of the motion model.\n\</span>
<span class="stringliteral">     By default, this parameter is initialized to the mid image\n\</span>
<span class="stringliteral">     line number.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -z \n\</span>
<span class="stringliteral">     Computes the covariance matrix of the motion model parameters.\n\</span>
<span class="stringliteral">\n"</span>);

<span class="preprocessor">#ifndef __NO_IMAGEIO_PNG_</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">ESTIMATION SUPPORT OPTIONS (input):\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -a [%%s]: support image or video path                       \n\</span>
<span class="stringliteral">     Motion2D makes it possible to estimate motion either on \n\</span>
<span class="stringliteral">     all the image (by defect), or on a part of the image. In \n\</span>
<span class="stringliteral">     this case, it is necessary to indicate to the software the\n\</span>
<span class="stringliteral">     position of the area on which the motion estimation must be \n\</span>
<span class="stringliteral">     done. This is carried out while associating each image of \n\</span>
<span class="stringliteral">     the video sequence a file called estimation support, corres-\n\</span>
<span class="stringliteral">     ponding to an image with same size, numbering and extension \n\</span>
<span class="stringliteral">     as the images to be treated. Thus, this option specify the \n\</span>
<span class="stringliteral">     path and the generic name of the files containing the images \n\</span>
<span class="stringliteral">     corresponding to the estimation support. The images format \n\</span>
<span class="stringliteral">     depends on the filename extension. We support only Mpeg2, PNG, \n\</span>
<span class="stringliteral">     PNM (PGM P5, PPM P6) and RAW (RAW8, RAW16) image file formats. \n\</span>
<span class="stringliteral">     Be aware, images to proceed (those specified by option -p \n\</span>
<span class="stringliteral">     and option -a) must have the same size.\n\</span>
<span class="stringliteral">     For example, to estimate the motion between images \n\</span>
<span class="stringliteral">     \"rond-point0001.png\" and \"rond-point0002.png\", the\n\</span>
<span class="stringliteral">     support file name must be \"support0001.png\".\n"</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">ESTIMATION SUPPORT OPTIONS (input):\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -a [%%s]: support image path                                  \n\</span>
<span class="stringliteral">     Motion2D makes it possible to estimate motion either on \n\</span>
<span class="stringliteral">     all the image (by defect), or on a part of the image. In \n\</span>
<span class="stringliteral">     this case, it is necessary to indicate to the software the\n\</span>
<span class="stringliteral">     position of the area on which the motion estimation must be \n\</span>
<span class="stringliteral">     done. This is carried out while associating each image of \n\</span>
<span class="stringliteral">     the video sequence a file called estimation support, corres-\n\</span>
<span class="stringliteral">     ponding to an image with same size, numbering and extension \n\</span>
<span class="stringliteral">     as the images to be treated. Thus, this option specify the \n\</span>
<span class="stringliteral">     path and the generic name of the files containing the images \n\</span>
<span class="stringliteral">     corresponding to the estimation support. The images format \n\</span>
<span class="stringliteral">     depends on the filename extension. We support only Mpeg2, PNM \n\</span>
<span class="stringliteral">     (PGM P5, PPM P6) and RAW (RAW8, RAW16) image file formats. \n\</span>
<span class="stringliteral">     Be aware, images to proceed (those specified by option -p \n\</span>
<span class="stringliteral">     and option -a) must have the same size.\n\</span>
<span class="stringliteral">     For example, to estimate the motion between images \n\</span>
<span class="stringliteral">     \"rond-point0001.pgm\" and \"rond-point0002.pgm\", the\n\</span>
<span class="stringliteral">     support file name must be \"support0001.pgm\".\n"</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -c [%%d]: support label \n\</span>
<span class="stringliteral">     This option is associated to the previous one. It fixes the\n\</span>
<span class="stringliteral">     value of the estimation support label where the estimation \n\</span>
<span class="stringliteral">     will be achieved. \n\</span>
<span class="stringliteral">\n"</span>);

  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">MULTI-RESOLUTION FRAMEWORK OPTIONS (input):\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -q [%%d]: nbsubsample                                             0\n\</span>
<span class="stringliteral">     Number of subsampling to apply to the images before\n\</span>
<span class="stringliteral">     starting the motion estimation process. If this parameter\n\</span>
<span class="stringliteral">     is equal to zero, images are not subsampled. If this \n\</span>
<span class="stringliteral">     parameter is greater than zero, images are resized at a lower\n\</span>
<span class="stringliteral">     resolution where the number of lines and columns is divided \n\</span>
<span class="stringliteral">     by 2^nbsubsample.\n\</span>
<span class="stringliteral">     Be aware, the estimated parametric motion model is returned \n\</span>
<span class="stringliteral">     at the highest resolution.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -n [%%u]: number of pyramid levels                                4\n\</span>
<span class="stringliteral">     Specify the number of levels in the Gaussian image pyramids\n\</span>
<span class="stringliteral">     and image gradients pyramids used in the multi-resolution\n\</span>
<span class="stringliteral">     framework. In general, when the size of the images to be\n\</span>
<span class="stringliteral">     treated is close to CIF format (352 X 288), it is advised\n\</span>
<span class="stringliteral">     to fix this parameter at 4. When the images are with QCIF\n\</span>
<span class="stringliteral">     format (176 X 144), this parameter can be fixed at 3.\n\</span>
<span class="stringliteral">     This parameter implicitly fix the index of the initial \n\</span>
<span class="stringliteral">     level in the pyramids where the robust estimate begins. This \n\</span>
<span class="stringliteral">     initial level is than equal to the number of levels in the \n\</span>
<span class="stringliteral">     pyramids minus one. The selected level is then that of lower\n\</span>
<span class="stringliteral">     resolution.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -l [%%u]: pyramid stop level                                      0\n\</span>
<span class="stringliteral">     Specify the level of the image pyramids where the estimation\n\</span>
<span class="stringliteral">     process will be stopped. This parameter in general fixed at\n\</span>
<span class="stringliteral">     zero (corresponds then to the level of higher resolution) \n\</span>
<span class="stringliteral">     can vary in the range [ 0, number_of_pyramid_levels - 1]. \n\</span>
<span class="stringliteral">     The coarsest level is given by number_of_pyramid_levels - 1.  \n\</span>
<span class="stringliteral">     The finest level is 0.\n\</span>
<span class="stringliteral">\n"</span>);

  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">RESULTS OPTIONS (output):\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -r [%%s]: dominant motion filename                        \n\</span>
<span class="stringliteral">     Specify the name of the file which will contain the \n\</span>
<span class="stringliteral">     estimated parametric dominant motion model results.\n\</span>
<span class="stringliteral">     This result file contains the values of the estimated \n\</span>
<span class="stringliteral">     2D parametric motion model given at the highest image\n\</span>
<span class="stringliteral">     resolution. The parameters of the estimated motion model \n\</span>
<span class="stringliteral">     are very small, especially affine and quadratic terms. To \n\</span>
<span class="stringliteral">     increase these parameters resolution, a multiplier factor \n\</span>
<span class="stringliteral">     can be applied to all the parameters (see option -e).\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -e [%%f]: multiplier factor for the motion parameter            1.0\n\</span>
<span class="stringliteral">     This option is associated with the -r option.\n\</span>
<span class="stringliteral">     It defines a multiplier factor applied to all the motion \n\</span>
<span class="stringliteral">     model parameter (c1,c2,a1,...a4,q1...q6) when those are \n\</span>
<span class="stringliteral">     saved in a result filename specified with option -r. \n"</span>);

<span class="preprocessor">#ifndef __NO_IMAGEIO_PNG_</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -b [%%s]: back warped image path                            \n\</span>
<span class="stringliteral">     Specify the path and the generic name of the files contain-\n\</span>
<span class="stringliteral">     ing the back-warped images built using the estimated motion\n\</span>
<span class="stringliteral">     model. We support only PNG, PNM (PGM P5, PPM P6) and RAW \n\</span>
<span class="stringliteral">     (RAW8, RAW16) image file formats. The format is selected by \n\</span>
<span class="stringliteral">     analysing the filename extension.\n\</span>
<span class="stringliteral">     Example: -b /tmp/B%%04.png\n"</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -b [%%s]: back warped image path                            \n\</span>
<span class="stringliteral">     Specify the path and the generic name of the files contain-\n\</span>
<span class="stringliteral">     ing the back-warped images built using the estimated motion\n\</span>
<span class="stringliteral">     model. We support only PNM (PGM P5, PPM P6) and RAW \n\</span>
<span class="stringliteral">     (RAW8, RAW16) image file formats. The format is selected by \n\</span>
<span class="stringliteral">     analysing the filename extension.\n\</span>
<span class="stringliteral">     Example: -b /tmp/B%%04.pgm\n"</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -j [%%d]: back warped image nrows                            \n\</span>
<span class="stringliteral">     Set the number of rows of the back-warped image.\n\</span>
<span class="stringliteral">     By default, the back-warped image has the same rows number\n\</span>
<span class="stringliteral">     than the images to proceed. This option is taken into \n\</span>
<span class="stringliteral">     account only when option -b is used.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -k [%%d]: back warped image ncols                            \n\</span>
<span class="stringliteral">     Set the number of columns of the back-warped image.\n\</span>
<span class="stringliteral">     By default, the back-warped image has the same rows number\n\</span>
<span class="stringliteral">     than the images to proceed. This option is taken into \n\</span>
<span class="stringliteral">     account only when option -b is used.\n"</span>);

   fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -t [%%d]: back warped image row origin                            0\n\</span>
<span class="stringliteral">     This option makes it possible to fix the co-ordinates of the \n\</span>
<span class="stringliteral">     row origin of the back-warped image compared to the origin \n\</span>
<span class="stringliteral">     of the images to treat. This option is taken into account \n\</span>
<span class="stringliteral">     only when option -b is used.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -u [%%d]: back warped image col origin                            0\n\</span>
<span class="stringliteral">     This option makes it possible to fix the co-ordinates of the \n\</span>
<span class="stringliteral">     column origin of the back-warped image compared to the origin \n\</span>
<span class="stringliteral">     of the images to treat. This option is taken into account \n\</span>
<span class="stringliteral">     only when option -b is used.\n"</span>);

<span class="preprocessor">#ifndef __NO_IMAGEIO_PNG_</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -w [%%s]: weights image path                            \n\</span>
<span class="stringliteral">     Specify the path and the generic name of the files contain-\n\</span>
<span class="stringliteral">     ing the M-estimator weights. These weights in [0,1] are\n\</span>
<span class="stringliteral">     rescaled in [0,255]. This map can be used to see\n\</span>
<span class="stringliteral">     if a pixel participate to the robust motion estimation \n\</span>
<span class="stringliteral">     (pixel in white) or is more considered as an outlier \n\</span>
<span class="stringliteral">     (pixel in black). We support only PNG, PNM (PGM P5, PPM P6) \n\</span>
<span class="stringliteral">     and RAW (RAW8, RAW16) image file formats. The format is \n\</span>
<span class="stringliteral">     selected by analysing the filename extension.\n\</span>
<span class="stringliteral">     Example: -w /tmp/W%%04.png\n"</span>);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -w [%%s]: weights image path                            \n\</span>
<span class="stringliteral">     Specify the path and the generic name of the files contain-\n\</span>
<span class="stringliteral">     ing the M-estimator weights. These weights in [0,1] are\n\</span>
<span class="stringliteral">     rescaled in [0,255]. This map can be used to see\n\</span>
<span class="stringliteral">     if a pixel participate to the robust motion estimation \n\</span>
<span class="stringliteral">     (pixel in white) or is more considered as an outlier \n\</span>
<span class="stringliteral">     (pixel in black). We support only PNM (PGM P5, PPM P6) \n\</span>
<span class="stringliteral">     and RAW (RAW8, RAW16) image file formats. The format is \n\</span>
<span class="stringliteral">     selected by analysing the filename extension.\n\</span>
<span class="stringliteral">     Example: -w /tmp/W%%04.pgm\n"</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
   fprintf(stdout, <span class="stringliteral">"\n\</span>
<span class="stringliteral">  -F [%%s]: field vector image path                           \n\</span>
<span class="stringliteral">     Specify the path and the generic name of the files contain-\n\</span>
<span class="stringliteral">     ing the displacement vectors in fieldshow format. \n\</span>
<span class="stringliteral">     Example: -w /tmp/F%%04.field\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">OTHER OPTIONS:\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -v\n\</span>
<span class="stringliteral">     Activate the verbose mode.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -h\n\</span>
<span class="stringliteral">     Print the help.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">  -?\n\</span>
<span class="stringliteral">     Print the help.\n\</span>
<span class="stringliteral">\n\</span>
<span class="stringliteral">\n"</span>);

  exit(0);
}

<span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Set the program options.</span>
<span class="comment"></span>
<span class="comment">*/</span>
<span class="keywordtype">void</span> getoptions(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv,
                string &amp;ipath, <span class="keywordtype">unsigned</span> &amp;nbsubsample,
                <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> &amp;frame, <span class="keywordtype">int</span> &amp;step, <span class="keywordtype">long</span> <span class="keywordtype">unsigned</span> &amp;niter,
                string &amp;model_id, <span class="keywordtype">bool</span> &amp;var_light,
                <span class="keywordtype">bool</span> &amp;model_orig_fixed,
                <span class="keywordtype">double</span> &amp;model_row_orig, <span class="keywordtype">double</span> &amp;model_col_orig,
                <span class="keywordtype">unsigned</span> &amp;pyr_nlevels, <span class="keywordtype">unsigned</span> &amp;pyr_stop_level,
                <span class="keywordtype">bool</span> &amp;compute_covariance,
                string &amp;rpath, string &amp;bpath,
                <span class="keywordtype">int</span> &amp;b_nrows, <span class="keywordtype">int</span> &amp;b_ncols, <span class="keywordtype">int</span> &amp;b_row_orig, <span class="keywordtype">int</span> &amp;b_col_orig,
                string &amp;wpath, string &amp;spath, <span class="keywordtype">int</span> &amp;slabel,
                <span class="keywordtype">double</span> &amp;multfactor, <span class="keywordtype">bool</span> &amp;verbose,
                <span class="keywordtype">unsigned</span> &amp;raw_nrows, <span class="keywordtype">unsigned</span> &amp;raw_ncols, string &amp;Fpath,
                <span class="keywordtype">bool</span> &amp;useModelAsInitialization)
{
  <span class="keywordtype">char</span> *optarg;
  <span class="keywordtype">int</span>   c;
  <span class="keywordflow">while</span> ((c = getoption(argc, argv, GETOPTARGS, &amp;optarg)) &gt; 1) {

    <span class="keywordflow">switch</span> (c) {
    <span class="keywordflow">case</span> <span class="charliteral">'a'</span>: spath = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'b'</span>: bpath = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'c'</span>: slabel = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'e'</span>: multfactor = (double) atof(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'f'</span>: frame = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'g'</span>: var_light = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'h'</span>: usage(argv[0], NULL); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'i'</span>: niter = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'j'</span>: b_nrows = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'k'</span>: b_ncols = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'l'</span>: pyr_stop_level = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'m'</span>: model_id = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'n'</span>: pyr_nlevels = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'p'</span>: ipath = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'q'</span>: nbsubsample = (unsigned) atoi( optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'r'</span>: rpath = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'s'</span>: step = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'t'</span>: b_row_orig = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'u'</span>: b_col_orig = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'v'</span>: verbose = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'x'</span>: model_orig_fixed = <span class="keyword">true</span>; model_col_orig = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'y'</span>: model_orig_fixed = <span class="keyword">true</span>; model_row_orig = atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'w'</span>: wpath = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'z'</span>: compute_covariance = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'?'</span>: usage(argv[0], NULL); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'C'</span>: raw_ncols = (unsigned)atoi(optarg); <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'F'</span>: Fpath = optarg; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'I'</span>: useModelAsInitialization = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <span class="charliteral">'R'</span>: raw_nrows = (unsigned)atoi(optarg); <span class="keywordflow">break</span>;

    <span class="keywordflow">default</span>:  usage(argv[0], NULL); <span class="keywordflow">break</span>;
    }
  }

  <span class="keywordflow">if</span> ((c == 1) || (c == -1)) {
    <span class="comment">// standalone param or error</span>
    fprintf(stderr, <span class="stringliteral">"Bad argument %s\n"</span>, optarg);
    exit(0);
  }

  <span class="comment">// Some option tests</span>
  <span class="keywordflow">if</span> ( !rpath.empty() ) {
    FILE *rfile = fopen(rpath.c_str(), <span class="stringliteral">"wb"</span>);
    <span class="keywordflow">if</span> (rfile == NULL) {
      cout &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"Bad argument -r: "</span>
           &lt;&lt; <span class="stringliteral">"Cannot create the result filename specified "</span>
           &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"with this option."</span>
           &lt;&lt; endl;
      exit(0);
    }
    fclose(rfile);
  }

  <span class="keywordflow">if</span> ( !spath.empty() ) {
    <span class="comment">// Test if the support label is set</span>
    <span class="keywordflow">if</span> (slabel == -1) {
      cout &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"Error: When using option -a to specify a support image path, "</span>
           &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"you have to specify the support label too with option -c"</span>
           &lt;&lt; endl;
      exit(0);
    }
  }

  <span class="keywordflow">if</span> (slabel != -1) {
    <span class="comment">// Test if the support image path is set</span>
    <span class="keywordflow">if</span> ( spath.empty() ) {
      cout &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"Error: When using option -c to specify a support label, "</span>
           &lt;&lt; endl
           &lt;&lt; <span class="stringliteral">"you have to specify the support image path too with option -a"</span>
           &lt;&lt; endl;
      exit(0);
    }
  }

  <span class="keywordflow">if</span> (pyr_nlevels &lt; 1) {
    <span class="comment">// The pyramids can not be build</span>
    cout &lt;&lt; endl
         &lt;&lt; <span class="stringliteral">"Error: When using option -n to specify the number of levels"</span>
         &lt;&lt; endl
         &lt;&lt; <span class="stringliteral">"in the pyramids. This number must be greater than zero. "</span>
         &lt;&lt; endl;
    exit(0);
  }

  <span class="keywordflow">if</span> ( bpath.empty() ) {
    <span class="keywordtype">bool</span> ommit = <span class="keyword">false</span>;
    <span class="keywordflow">if</span> (b_nrows != -1) {
      cout &lt;&lt; <span class="stringliteral">"Warning: option -j ignored. "</span> &lt;&lt; endl;
      ommit = <span class="keyword">true</span>;
    }
    <span class="keywordflow">if</span> (b_ncols != -1) {
      cout &lt;&lt; <span class="stringliteral">"Warning: option -k ignored. "</span> &lt;&lt; endl;
      ommit = <span class="keyword">true</span>;
    }
    <span class="keywordflow">if</span> (b_row_orig != 0) {
      cout &lt;&lt; <span class="stringliteral">"Warning: option -t ignored. "</span> &lt;&lt; endl;
      ommit = <span class="keyword">true</span>;
    }
    <span class="keywordflow">if</span> (b_col_orig != 0) {
      cout &lt;&lt; <span class="stringliteral">"Warning: option -u ignored. "</span> &lt;&lt; endl;
      ommit = <span class="keyword">true</span>;
    }
    <span class="keywordflow">if</span> (ommit == <span class="keyword">true</span>)
      cout &lt;&lt; <span class="stringliteral">"To take it into account don't ommit option -b."</span> &lt;&lt; endl &lt;&lt; endl;
  }
}

<span class="comment">/*</span>
<span class="comment"></span>
<span class="comment">  Get next command line option and parameter</span>
<span class="comment"></span>
<span class="comment">  PARAMETERS:</span>
<span class="comment"></span>
<span class="comment">      argc - count of command line arguments</span>
<span class="comment">      argv - array of command line argument strings</span>
<span class="comment">      pszValidOpts - string of valid, case-sensitive option characters,</span>
<span class="comment">                     a colon ':' following a given character means that</span>
<span class="comment">                     option can take a parameter</span>
<span class="comment">      ppszParam - pointer to a pointer to a string for output</span>
<span class="comment"></span>
<span class="comment">  RETURNS:</span>
<span class="comment"></span>
<span class="comment">      If valid option is found, the character value of that option</span>
<span class="comment">          is returned, and *ppszParam points to the parameter if given,</span>
<span class="comment">          or is NULL if no param</span>
<span class="comment">      If standalone parameter (with no option) is found, 1 is returned,</span>
<span class="comment">          and *ppszParam points to the standalone parameter</span>
<span class="comment">      If option is found, but it is not in the list of valid options,</span>
<span class="comment">          -1 is returned, and *ppszParam points to the invalid argument</span>
<span class="comment">      When end of argument list is reached, 0 is returned, and</span>
<span class="comment">          *ppszParam is NULL</span>
<span class="comment">*/</span>
<span class="keywordtype">int</span> getoption (
    <span class="keywordtype">int</span> argc,
    <span class="keywordtype">char</span>** argv,
    <span class="keywordtype">char</span>* pszValidOpts,
    <span class="keywordtype">char</span>** ppszParam)
{
  <span class="keyword">static</span> <span class="keywordtype">int</span> iArg = 1;
  <span class="keywordtype">int</span> chOpt;
  <span class="keywordtype">char</span>* psz = NULL;
  <span class="keywordtype">char</span>* pszParam = NULL;

  <span class="keywordflow">if</span> (iArg &lt; argc) {
    psz = &amp;(argv[iArg][0]);
    <span class="keywordflow">if</span> (*psz == <span class="charliteral">'-'</span>) { <span class="comment">// || *psz == '/')  {</span>
      <span class="comment">// we have an option specifier</span>
      chOpt = argv[iArg][1];
      <span class="keywordflow">if</span> (isalnum(chOpt) || ispunct(chOpt)) {
        <span class="comment">// we have an option character</span>
        psz = strchr(pszValidOpts, chOpt);
        <span class="keywordflow">if</span> (psz != NULL) {
          <span class="comment">// option is valid, we want to return chOpt</span>
          <span class="keywordflow">if</span> (psz[1] == <span class="charliteral">':'</span>) {
            <span class="comment">// option can have a parameter</span>
            psz = &amp;(argv[iArg][2]);
            <span class="keywordflow">if</span> (*psz == <span class="charliteral">'\0'</span>) {
              <span class="comment">// must look at next argv for param</span>
              <span class="keywordflow">if</span> (iArg+1 &lt; argc) {
                psz = &amp;(argv[iArg+1][0]);
                <span class="comment">// next argv is the param</span>
                iArg++;
                pszParam = psz;
              }
              <span class="keywordflow">else</span> {
                <span class="comment">// reached end of args looking for param</span>
              }

            }
            <span class="keywordflow">else</span> {
              <span class="comment">// param is attached to option</span>
              pszParam = psz;
            }
          }
          <span class="keywordflow">else</span> {
            <span class="comment">// option is alone, has no parameter</span>
          }
        }
        <span class="keywordflow">else</span> {
          <span class="comment">// option specified is not in list of valid options</span>
          chOpt = -1;
          pszParam = &amp;(argv[iArg][0]);
        }
      }
      <span class="keywordflow">else</span> {
        <span class="comment">// though option specifier was given, option character</span>
        <span class="comment">// is not alpha or was was not specified</span>
        chOpt = -1;
        pszParam = &amp;(argv[iArg][0]);
      }
    }
    <span class="keywordflow">else</span> {
      <span class="comment">// standalone arg given with no option specifier</span>
      chOpt = 1;
      pszParam = &amp;(argv[iArg][0]);
    }
  }
  <span class="keywordflow">else</span> {
    <span class="comment">// end of argument list</span>
    chOpt = 0;
  }

  iArg++;
  *ppszParam = pszParam;
  <span class="keywordflow">return</span> (chOpt);
}
</pre></div><hr> 
<address><small>Motion2D is Copyright &copy; 1995-2005 by <a href="http://www.inria.fr/index.en.html">Inria</a></small></address>
<address><small>This documentation was generated on 31 Jan 2005 by Fabien Spindler for 
Motion2D 1.3.11 using <a href="http://www.doxygen.org/index.html"> 
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=77 height=37></a>1.2.18 written by <a href="mailto:dimitri@stack.nl">Dimitri 
van Heesch</a>, &copy;&nbsp;1997-2005</small></address>
</body>
</html>
